<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueReader | Interactive Library</title>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCh6YZVCawcGfyPz6s1K9DJqBeIC-c7Hsw",
            authDomain: "readersparadize-85e8e.firebaseapp.com",
            projectId: "readersparadize-85e8e",
            storageBucket: "readersparadize-85e8e.firebasestorage.app",
            messagingSenderId: "168539796198",
            appId: "1:168539796198:web:d01f9b7915292e6c5fc127",
            measurementId: "G-GZ61PZQXC5"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.auth = auth;
        window.db = db;
        window.appId = appId;
        window.googleProvider = new GoogleAuthProvider();
        
        // Expose Auth functions
        window.loginEmail = async (e, p) => signInWithEmailAndPassword(auth, e, p);
        window.signupEmail = async (e, p) => createUserWithEmailAndPassword(auth, e, p);
        window.loginGoogle = async () => signInWithPopup(auth, window.googleProvider);
        window.logout = async () => signOut(auth);
        
        // Initial Auth Logic
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        signInAnonymously(auth).catch(err => console.error("Anon Auth Failed:", err));
                    }
                });
            }
        };
        initAuth();

        // Firestore Helpers
        window.saveBookProgress = async (bookId, page) => {
            const user = auth.currentUser;
            if(!user || user.isAnonymous) return;
            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', bookId);
            await setDoc(ref, { page: page, lastRead: new Date().toISOString(), bookId: bookId }, { merge: true });
        };

        window.toggleFav = async (bookId) => {
             const user = auth.currentUser;
            if(!user || user.isAnonymous) return;
            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'preferences', 'favorites');
            const docSnap = await getDoc(ref);
            if(docSnap.exists() && docSnap.data().ids.includes(bookId)) {
                await updateDoc(ref, { ids: arrayRemove(bookId) });
                return false; 
            } else {
                await setDoc(ref, { ids: arrayUnion(bookId) }, { merge: true });
                return true; 
            }
        };

        window.addBookToDB = async (bookData) => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'books');
            await addDoc(colRef, bookData);
        };

        window.subscribeToBooks = (callback) => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'books');
            return onSnapshot(colRef, (snapshot) => {
                const books = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                callback(books);
            }, (error) => console.error("Error fetching books:", error));
        };
    </script>

    <style>
        /* Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        /* CSS Variables */
        :root {
            --primary-color: #0d6efd;
            --primary-color-light: #3b8aff;
            --text-light: #f0f0f0;
            --text-dark: #333;
            --sidebar-bg-light: rgba(248, 249, 250, 0.95); /* Slight transparency for glass effect */
            --content-bg-light: rgba(255, 255, 255, 0.95);
            --border-color-light: #e9ecef;
            --bg-dark: #121212;
            --text-dark-theme: #e0e0e0;
            --sidebar-bg-dark: rgba(30, 30, 30, 0.95);
            --content-bg-dark: rgba(42, 42, 42, 0.95);
            --border-color-dark: #444;
            --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #f0f2f5; color: var(--text-dark); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 2rem; transition: background-color 0.3s, color 0.3s; overflow-x: hidden; }
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; }

        /* Main Container */
        .portfolio-container { width: 100%; max-width: 1200px; background: var(--content-bg-light); border-radius: 20px; box-shadow: var(--box-shadow); display: flex; overflow: hidden; min-height: 80vh; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }

        /* Sidebar */
        .sidebar { width: 300px; background-color: var(--sidebar-bg-light); padding: 40px 30px; text-align: center; border-right: 1px solid var(--border-color-light); flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-content { position: sticky; top: 40px; width: 100%; }
        .profile-photo { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--primary-color); object-fit: cover; margin-bottom: 20px; margin-left: auto; margin-right: auto; display: block; background: #ddd;}
        .name { font-size: 1.5rem; font-weight: 600; margin-bottom: 5px; }
        .title { font-size: 0.9rem; font-weight: 400; color: var(--text-dark); background: var(--border-color-light); display: inline-block; padding: 5px 15px; border-radius: 15px; margin-bottom: 20px; }
        .separator { border: 0; height: 1px; background: var(--border-color-light); margin: 20px 0; }
        
        .nav-menu { list-style: none; text-align: left; margin-top: 20px; }
        .nav-menu li { margin-bottom: 15px; }
        .nav-btn { width: 100%; text-align: left; padding: 12px 15px; background: transparent; border: none; border-radius: 10px; color: #666; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s; font-size: 1rem; }
        .nav-btn:hover, .nav-btn.active { background: var(--primary-color); color: white; transform: translateX(5px); box-shadow: 0 4px 10px rgba(13, 110, 253, 0.2); }
        .nav-btn i { font-size: 1.2rem; }

        /* Main Content */
        .main-content { flex-grow: 1; padding: 40px; position: relative; overflow-y: auto; max-height: 90vh; }
        
        /* Tabs & Filters */
        .tabs ul { list-style: none; display: flex; gap: 15px; border-bottom: 1px solid var(--border-color-light); margin-bottom: 30px; flex-wrap: wrap;}
        .tab-link { background: none; border: none; cursor: pointer; color: #888; padding: 10px 5px; display: block; font-weight: 500; position: relative; border-bottom: 3px solid transparent; transition: color 0.3s, border-color 0.3s; font-size: 1rem; }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        
        .section-title { font-size: 1.8rem; margin-bottom: 10px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .section-subtitle { font-size: 1rem; color: #888; margin-bottom: 30px; }

        /* Book Grid (Portfolio Grid) */
        .portfolio-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }
        .project-card { background: var(--sidebar-bg-light); border-radius: 15px; padding: 15px; transition: all 0.3s; position: relative; cursor: pointer; border: 1px solid transparent; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: var(--primary-color-light); }
        .book-cover { width: 100%; aspect-ratio: 2/3; border-radius: 10px; object-fit: cover; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .project-card h5 { font-size: 1rem; font-weight: 600; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .project-card p { font-size: 0.85rem; color: #888; margin-bottom: 10px; }
        
        /* Progress Bar */
        .progress-bar { height: 4px; background: var(--border-color-light); border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.5s; }

        /* Buttons */
        .btn-primary { padding: 10px 25px; background: var(--primary-color); color: #fff; border: none; border-radius: 25px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.3s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-primary:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3); }
        
        .toggle-btn { position: absolute; top: 30px; right: 40px; background: var(--sidebar-bg-light); color: var(--text-dark); width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid var(--border-color-light); cursor: pointer; font-size: 1.2rem; z-index: 10; transition: all 0.3s; }
        .toggle-btn:hover { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* Dark Mode */
        body.dark-mode { background-color: #050505; color: var(--text-dark-theme); }
        .dark-mode .portfolio-container { background: var(--content-bg-dark); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); border-color: rgba(255,255,255,0.05); }
        .dark-mode .sidebar { background-color: var(--sidebar-bg-dark); border-right-color: var(--border-color-dark); }
        .dark-mode .title, .dark-mode .nav-btn, .dark-mode .project-card { background: var(--sidebar-bg-dark); color: var(--text-dark-theme); }
        .dark-mode .nav-btn:hover, .dark-mode .nav-btn.active { background: var(--primary-color); color: white; }
        .dark-mode .separator, .dark-mode .tabs ul { border-color: var(--border-color-dark); }
        .dark-mode .toggle-btn { background: var(--sidebar-bg-dark); color: var(--text-dark-theme); border-color: var(--border-color-dark); }
        .dark-mode .toggle-btn:hover { background: var(--primary-color); color: white; }
        .dark-mode .project-card p { color: #aaa; }
        .dark-mode .progress-bar { background: #444; }
        
        /* Loading & Modals */
        #loadingScreen { position: fixed; inset: 0; background: var(--content-bg-light); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: 700; }
        .dark-mode #loadingScreen { background: var(--bg-dark); color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-box { background: var(--content-bg-light); padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; position: relative; transform: translateY(20px); transition: transform 0.3s; }
        .modal-overlay.active .modal-box { transform: translateY(0); }
        .dark-mode .modal-box { background: var(--content-bg-dark); color: var(--text-dark-theme); }
        
        .form-group { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color-light); background: var(--sidebar-bg-light); color: var(--text-dark); outline: none; }
        .dark-mode .form-input { background: var(--sidebar-bg-dark); border-color: var(--border-color-dark); color: white; }

        /* PDF Reader specific */
        #readerModal { position: fixed; inset: 0; z-index: 3000; background: #1a1a1a; display: none; flex-direction: column; }
        #readerModal.active { display: flex; }
        .reader-header { height: 60px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; }
        .reader-body { flex-grow: 1; position: relative; }
        .reader-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; display: flex; gap: 10px; align-items: center; color: white; }

        /* Animations */
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-o { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--primary-color); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }

        @media (max-width: 900px) {
            .portfolio-container { flex-direction: column; height: auto; min-height: 100vh; border-radius: 0; width: 100%; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color-light); padding: 20px; }
            .sidebar-content { position: static; }
            .profile-photo { width: 80px; height: 80px; }
            .nav-menu { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; }
            .nav-menu li { margin-bottom: 0; flex-shrink: 0; }
            .nav-btn { padding: 8px 15px; font-size: 0.9rem; background: var(--border-color-light); border-radius: 20px; justify-content: center; }
            .nav-btn:hover { transform: none; }
            .main-content { padding: 20px; overflow-y: visible; }
            .toggle-btn { top: 15px; right: 15px; width: 35px; height: 35px; font-size: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Sound -->
    <audio id="clickSound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="></audio> 

    <!-- Particles Background -->
    <canvas id="particles-js"></canvas>

    <!-- Loading -->
    <div id="loadingScreen">
        L<span class="loading-o"></span>ADING
    </div>

    <!-- Theme Toggle -->
    <button class="toggle-btn" onclick="toggleTheme()">
        <i class="ph-fill ph-moon" id="themeIcon"></i>
    </button>

    <div class="portfolio-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- Branding / Logo -->
                <div style="margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="ph-fill ph-book-open-text" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <h2 style="font-size: 1.8rem; font-weight: 700; margin: 0;">Blue<span style="color: var(--primary-color);">Reader</span></h2>
                </div>

                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Guest" id="userAvatar" class="profile-photo" alt="Profile">
                <h1 class="name" id="userName">Guest Reader</h1>
                <span class="title" id="userStatus">Log in to sync</span>
                
                <div class="separator"></div>

                <ul class="nav-menu">
                    <li><button class="nav-btn active" onclick="switchTab('home', this)"><i class="ph-bold ph-house"></i> Home</button></li>
                    <li><button class="nav-btn" onclick="switchTab('library', this)"><i class="ph-bold ph-books"></i> Library</button></li>
                    <li><button class="nav-btn" onclick="switchTab('continue', this)"><i class="ph-bold ph-clock-counter-clockwise"></i> Continue</button></li>
                    <li id="adminBtn" style="display: none;"><button class="nav-btn" onclick="openAdmin()"><i class="ph-bold ph-plus-circle"></i> Add Book</button></li>
                </ul>

                <div class="separator"></div>

                <button id="authBtn" class="btn-primary" style="width: 100%; justify-content: center; margin-top: 10px;" onclick="handleAuthClick()">
                    Sign In
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- View: Home -->
            <div id="view-home" class="tab-content" style="display: block;">
                <div class="section-title">
                    <h2>Discover</h2>
                </div>
                <p class="section-subtitle">Explore our curated collection of timeless classics.</p>
                
                <div class="tabs">
                    <ul id="genreTabs">
                        <li><button class="tab-link active" onclick="filterBooks('All', this)">All</button></li>
                        <!-- Genres injected via JS -->
                    </ul>
                </div>

                <div class="portfolio-grid" id="publicGrid">
                    <!-- Books injected here -->
                </div>
            </div>

            <!-- View: Library (Requires Login mostly, but acts as secondary view) -->
            <div id="view-library" class="tab-content" style="display: none;">
                <div class="section-title">
                    <h2>My Library</h2>
                </div>
                <p class="section-subtitle">Books you have favorited or started.</p>
                <div class="portfolio-grid" id="libraryGrid">
                    <div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">
                        Log in and start reading to build your library.
                    </div>
                </div>
            </div>

             <!-- View: Continue -->
             <div id="view-continue" class="tab-content" style="display: none;">
                <div class="section-title">
                    <h2>Continue Reading</h2>
                </div>
                <p class="section-subtitle">Pick up where you left off.</p>
                <div class="portfolio-grid" id="continueGrid">
                    <!-- Injected -->
                </div>
            </div>
        </main>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal-box">
            <button onclick="closeModal('authModal')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #888;"><i class="ph-bold ph-x"></i></button>
            <h2 class="section-title" style="justify-content: center;">Welcome</h2>
            <p style="text-align: center; color: #888; margin-bottom: 20px;">Sign in to save your progress across devices.</p>
            
            <button class="btn-primary" onclick="handleGoogleLogin()" style="width: 100%; justify-content: center; background: white; color: #333; border: 1px solid #ddd; margin-bottom: 20px;">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" style="width: 20px; margin-right: 10px;"> Continue with Google
            </button>

            <div style="text-align: center; color: #aaa; margin-bottom: 15px; font-size: 0.8rem;">OR EMAIL</div>

            <form onsubmit="handleEmailAuth(event)">
                <div class="form-group">
                    <input type="email" id="emailInput" class="form-input" placeholder="Email Address" required>
                </div>
                <div class="form-group">
                    <input type="password" id="passInput" class="form-input" placeholder="Password" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; justify-content: center;">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Admin Modal -->
    <div class="modal-overlay" id="adminModal">
        <div class="modal-box">
            <button onclick="closeModal('adminModal')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #888;"><i class="ph-bold ph-x"></i></button>
            <h2 class="section-title">Add Book</h2>
            <form onsubmit="submitNewBook(event)">
                <div class="form-group"><input type="text" id="nbTitle" class="form-input" placeholder="Title" required></div>
                <div class="form-group"><input type="text" id="nbAuthor" class="form-input" placeholder="Author" required></div>
                <div class="form-group"><input type="text" id="nbGenre" class="form-input" placeholder="Genre" required></div>
                <div class="form-group"><input type="url" id="nbCover" class="form-input" placeholder="Cover Image URL" required></div>
                <div class="form-group"><input type="url" id="nbPdf" class="form-input" placeholder="PDF Link (Google Drive/OneDrive/Direct)" required></div>
                <button type="submit" class="btn-primary" style="width: 100%; justify-content: center;">Add to Library</button>
            </form>
        </div>
    </div>

    <!-- PDF Reader -->
    <div id="readerModal">
        <div class="reader-header">
            <button onclick="closeReader()" style="background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; gap: 5px;"><i class="ph-bold ph-arrow-left"></i> Back</button>
            <span id="readerTitle" style="font-weight: 600;">Book Title</span>
            <button id="readerFavBtn" onclick="toggleReaderFav()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;"><i class="ph-heart"></i></button>
        </div>
        <div class="reader-body">
            <iframe id="pdfFrame" style="width: 100%; height: 100%; border: none;" src=""></iframe>
            <div class="reader-controls">
                <span>Page</span>
                <input type="number" id="pageInput" style="width: 50px; background: #333; border: none; color: white; text-align: center; border-radius: 5px; padding: 5px;" value="1">
                <button onclick="saveCurrentPage()" style="background: var(--primary-color); color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.8rem;">SAVE</button>
            </div>
        </div>
    </div>

    <!-- Advanced Constellation Particles Script -->
    <script>
        const canvas = document.getElementById('particles-js');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let particles = [];
        let mouse = { x: null, y: null, radius: 150 };

        function initCanvas() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            
            // Create particles
            particles = [];
            const numParticles = (width * height) / 9000; // Responsive density
            for (let i = 0; i < numParticles; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 1, // Velocity X
                    vy: (Math.random() - 0.5) * 1, // Velocity Y
                    size: Math.random() * 3 + 1
                });
            }
        }

        window.addEventListener('resize', initCanvas);
        window.addEventListener('mousemove', (e) => {
            mouse.x = e.x;
            mouse.y = e.y;
        });
        window.addEventListener('mouseout', () => {
            mouse.x = null;
            mouse.y = null;
        });

        function animateParticles() {
            ctx.clearRect(0, 0, width, height);
            
            const isDark = document.body.classList.contains('dark-mode');
            const dotColor = isDark ? 'rgba(255, 255, 255, 0.5)' : 'rgba(13, 110, 253, 0.5)';
            const lineColor = isDark ? '255, 255, 255' : '13, 110, 253'; // rgb string for opacity manip

            // Update & Draw Particles
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;

                // Bounce off edges
                if (p.x < 0 || p.x > width) p.vx *= -1;
                if (p.y < 0 || p.y > height) p.vy *= -1;

                // Mouse Interaction: repulse slightly
                if(mouse.x) {
                    let dx = mouse.x - p.x;
                    let dy = mouse.y - p.y;
                    let distance = Math.sqrt(dx*dx + dy*dy);
                    if (distance < mouse.radius) {
                        const forceDirectionX = dx / distance;
                        const forceDirectionY = dy / distance;
                        const force = (mouse.radius - distance) / mouse.radius;
                        const directionX = forceDirectionX * force * 3;
                        const directionY = forceDirectionY * force * 3;
                        p.x -= directionX;
                        p.y -= directionY;
                    }
                }

                // Draw Dot
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = dotColor;
                ctx.fill();
            });

            // Draw Connections
            for (let a = 0; a < particles.length; a++) {
                for (let b = a; b < particles.length; b++) {
                    let dx = particles[a].x - particles[b].x;
                    let dy = particles[a].y - particles[b].y;
                    let distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 120) {
                        ctx.beginPath();
                        ctx.strokeStyle = `rgba(${lineColor}, ${1 - distance / 120})`;
                        ctx.lineWidth = 1;
                        ctx.moveTo(particles[a].x, particles[a].y);
                        ctx.lineTo(particles[b].x, particles[b].y);
                        ctx.stroke();
                    }
                }
                
                // Connect to mouse
                if(mouse.x) {
                    let dx = particles[a].x - mouse.x;
                    let dy = particles[a].y - mouse.y;
                    let distance = Math.sqrt(dx*dx + dy*dy);
                    if(distance < 150) {
                         ctx.beginPath();
                        ctx.strokeStyle = `rgba(${lineColor}, ${1 - distance / 150})`;
                        ctx.lineWidth = 1;
                        ctx.moveTo(particles[a].x, particles[a].y);
                        ctx.lineTo(mouse.x, mouse.y);
                        ctx.stroke();
                    }
                }
            }

            requestAnimationFrame(animateParticles);
        }

        initCanvas();
        animateParticles();
    </script>

    <script>
        // --- APP LOGIC ---
        const adminEmails = ["your-email@gmail.com"]; 

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = 'sine'; o.frequency.setValueAtTime(800, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.05);
        }

        const staticBooks = [
            { id: 'b1', title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', genre: 'Classic', cover: 'https://upload.wikimedia.org/wikipedia/commons/7/7a/The_Great_Gatsby_Cover_1925_Retouched.jpg', pdfUrl: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf' },
            { id: 'b2', title: 'Pride and Prejudice', author: 'Jane Austen', genre: 'Romance', cover: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/PrideAndPrejudiceTitlePage.jpg/800px-PrideAndPrejudiceTitlePage.jpg', pdfUrl: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf' }
        ];

        let appState = {
            user: null,
            theme: 'light',
            progress: {},
            favorites: [],
            currentBook: null,
            books: [...staticBooks],
            filter: 'All'
        };

        // Init
        window.onload = () => {
            setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 1500);
            if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
                appState.theme = 'dark';
                document.getElementById('themeIcon').className = 'ph-fill ph-sun';
            }
        };

        // Listeners
        const bookInterval = setInterval(() => {
            if (window.subscribeToBooks) {
                clearInterval(bookInterval);
                window.subscribeToBooks((firestoreBooks) => {
                    appState.books = [...staticBooks, ...firestoreBooks];
                    render();
                });
            }
        }, 500);

        const authInterval = setInterval(() => {
            if (window.auth) {
                clearInterval(authInterval);
                window.auth.onAuthStateChanged(async (user) => {
                    appState.user = user;
                    if (user && !user.isAnonymous) {
                        // Load real data if needed
                        document.getElementById('userAvatar').src = user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`;
                        document.getElementById('userName').innerText = user.displayName || user.email.split('@')[0];
                        document.getElementById('userStatus').innerText = "Reader";
                        document.getElementById('authBtn').innerText = "Sign Out";
                    } else {
                        document.getElementById('userAvatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=Guest`;
                        document.getElementById('userName').innerText = "Guest User";
                        document.getElementById('userStatus').innerText = "Sign in to sync";
                        document.getElementById('authBtn').innerText = "Sign In";
                    }
                    render();
                });
            }
        }, 100);

        // UI Functions
        function toggleTheme() {
            playSound();
            document.body.classList.toggle('dark-mode');
            appState.theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', appState.theme);
            document.getElementById('themeIcon').className = appState.theme === 'dark' ? 'ph-fill ph-sun' : 'ph-fill ph-moon';
        }

        function switchTab(tabName, btn) {
            playSound();
            // Hide all tabs
            ['home', 'library', 'continue'].forEach(t => document.getElementById('view-'+t).style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected
            document.getElementById('view-'+tabName).style.display = 'block';
            btn.classList.add('active');
        }

        function filterBooks(genre, btn) {
            playSound();
            appState.filter = genre;
            document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function render() {
            // Admin
            if (appState.user && !appState.user.isAnonymous && adminEmails.includes(appState.user.email)) {
                document.getElementById('adminBtn').style.display = 'block';
            } else {
                document.getElementById('adminBtn').style.display = 'none';
            }

            // Filters
            const genres = ['All', ...new Set(appState.books.map(b => b.genre))];
            document.getElementById('genreTabs').innerHTML = genres.map(g => `
                <li><button class="tab-link ${appState.filter === g ? 'active' : ''}" onclick="filterBooks('${g}', this)">${g}</button></li>
            `).join('');

            // Main Grid
            const filtered = appState.filter === 'All' ? appState.books : appState.books.filter(b => b.genre === appState.filter);
            document.getElementById('publicGrid').innerHTML = filtered.map(b => getBookCard(b)).join('');

            // Library Grid (Favs + Started) -- Simplified for demo, normally check appState.favorites
            // We will just show everything for now in library view but with progress bars
            const started = appState.books.filter(b => appState.progress[b.id]);
            if(started.length > 0) {
                document.getElementById('libraryGrid').innerHTML = started.map(b => getBookCard(b)).join('');
                document.getElementById('continueGrid').innerHTML = started.map(b => getBookCard(b)).join('');
            } else {
                document.getElementById('continueGrid').innerHTML = '<p style="color:#888;">No reading history yet.</p>';
            }
        }

        function getBookCard(book) {
            const progress = appState.progress[book.id];
            const progressPercent = progress ? (progress.page / 200 * 100) : 0; // Mock total pages
            
            return `
                <div class="project-card" onclick="openBook('${book.id}')">
                    <img src="${book.cover}" class="book-cover" onerror="this.src='https://placehold.co/200x300'">
                    <h5>${book.title}</h5>
                    <p>${book.author}</p>
                    ${progress ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <p style="font-size: 0.7rem; margin-top: 5px;">Pg ${progress.page}</p>
                    ` : ''}
                </div>
            `;
        }

        // Modal Functions
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openAdmin() { document.getElementById('adminModal').classList.add('active'); }
        
        function handleAuthClick() {
            if(appState.user && !appState.user.isAnonymous) {
                window.logout();
            } else {
                document.getElementById('authModal').classList.add('active');
            }
        }

        async function handleGoogleLogin() {
            try { await window.loginGoogle(); closeModal('authModal'); } catch(e) { alert(e.message); }
        }

        async function handleEmailAuth(e) {
            e.preventDefault();
            const em = document.getElementById('emailInput').value;
            const pw = document.getElementById('passInput').value;
            try { await window.loginEmail(em, pw); closeModal('authModal'); }
            catch(err) {
                if(err.code.includes('not-found') || err.code.includes('invalid')) {
                    try { await window.signupEmail(em, pw); closeModal('authModal'); }
                    catch(e2) { alert(e2.message); }
                }
            }
        }

        async function submitNewBook(e) {
            e.preventDefault();
            
            let pdf = document.getElementById('nbPdf').value;
            
            // --- AUTO-FIX LINK LOGIC ---
            // 1. Google Drive (Standard View -> Preview)
            if (pdf.includes("drive.google.com") && pdf.includes("/view")) {
                pdf = pdf.replace("/view", "/preview");
            }
            
            // 2. Dropbox (Download -> Raw)
            if (pdf.includes("dropbox.com") && (pdf.includes("dl=0") || pdf.includes("?dl=0"))) {
                pdf = pdf.replace("dl=0", "raw=1");
            }

            // 3. OneDrive (Basic Open URL hack)
            // If user pastes a direct browser URL from OneDrive business
            // We try to append embedview, though this is hit or miss without the official embed button
            if (pdf.includes("sharepoint.com") || pdf.includes("1drv.ms")) {
                // Try to ensure we are not downloading
                if(pdf.includes("download=1")) pdf = pdf.replace("download=1", "action=embedview");
            }

            const book = {
                title: document.getElementById('nbTitle').value,
                author: document.getElementById('nbAuthor').value,
                genre: document.getElementById('nbGenre').value,
                cover: document.getElementById('nbCover').value,
                pdfUrl: pdf,
                createdAt: new Date().toISOString()
            };
            await window.addBookToDB(book);
            closeModal('adminModal');
            e.target.reset();
        }

        // Reader Logic
        function openBook(id) {
            if(!appState.user || appState.user.isAnonymous) {
                document.getElementById('authModal').classList.add('active');
                return;
            }
            playSound();
            const book = appState.books.find(b => b.id === id);
            appState.currentBook = book;
            document.getElementById('readerTitle').innerText = book.title;
            document.getElementById('pdfFrame').src = book.pdfUrl + "#toolbar=0";
            document.getElementById('readerModal').classList.add('active');
            
            if(appState.progress[id]) document.getElementById('pageInput').value = appState.progress[id].page;
            
            // Update heart
            const isFav = appState.favorites.includes(id);
            document.getElementById('readerFavBtn').innerHTML = isFav ? '<i class="ph-fill ph-heart" style="color: red;"></i>' : '<i class="ph-heart"></i>';
        }

        function closeReader() {
            document.getElementById('readerModal').classList.remove('active');
            document.getElementById('pdfFrame').src = "";
            render();
        }

        async function saveCurrentPage() {
            const page = parseInt(document.getElementById('pageInput').value);
            const id = appState.currentBook.id;
            appState.progress[id] = { page, lastRead: new Date() };
            await window.saveBookProgress(id, page);
            alert("Progress Saved!");
        }

        async function toggleReaderFav() {
            const id = appState.currentBook.id;
            if(appState.favorites.includes(id)) {
                appState.favorites = appState.favorites.filter(x => x!==id);
            } else {
                appState.favorites.push(id);
            }
            const isFav = appState.favorites.includes(id);
            document.getElementById('readerFavBtn').innerHTML = isFav ? '<i class="ph-fill ph-heart" style="color: red;"></i>' : '<i class="ph-heart"></i>';
            await window.toggleFav(id);
        }
    </script>
</body>
</html>