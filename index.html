<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueReader | Immersive Reading</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCh6YZVCawcGfyPz6s1K9DJqBeIC-c7Hsw",
            authDomain: "readersparadize-85e8e.firebaseapp.com",
            projectId: "readersparadize-85e8e",
            storageBucket: "readersparadize-85e8e.firebasestorage.app",
            messagingSenderId: "168539796198",
            appId: "1:168539796198:web:d01f9b7915292e6c5fc127",
            measurementId: "G-GZ61PZQXC5"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.auth = auth;
        window.db = db;
        window.appId = appId;
        window.googleProvider = new GoogleAuthProvider();
        
        // Expose Auth functions
        window.loginEmail = async (e, p) => signInWithEmailAndPassword(auth, e, p);
        window.signupEmail = async (e, p) => createUserWithEmailAndPassword(auth, e, p);
        window.loginGoogle = async () => signInWithPopup(auth, window.googleProvider);
        window.logout = async () => signOut(auth);
        
        // Initial Auth Logic (Crucial for permission errors)
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                // Only sign in anonymously if no user is currently signed in
                // This prevents overwriting an existing persistent session on reload
                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        signInAnonymously(auth).catch(err => console.error("Anon Auth Failed:", err));
                    }
                });
            }
        };
        initAuth();

        // Firestore Helpers
        window.saveBookProgress = async (bookId, page) => {
            const user = auth.currentUser;
            if(!user || user.isAnonymous) return; // Don't save progress for guest users in this demo logic
            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', bookId);
            await setDoc(ref, { 
                page: page, 
                lastRead: new Date().toISOString(),
                bookId: bookId 
            }, { merge: true });
        };

        window.toggleFav = async (bookId) => {
             const user = auth.currentUser;
            if(!user || user.isAnonymous) return;
            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'preferences', 'favorites');
            const docSnap = await getDoc(ref);
            
            if(docSnap.exists() && docSnap.data().ids.includes(bookId)) {
                await updateDoc(ref, { ids: arrayRemove(bookId) });
                return false; 
            } else {
                await setDoc(ref, { ids: arrayUnion(bookId) }, { merge: true });
                return true; 
            }
        };

        // Admin: Add Book
        window.addBookToDB = async (bookData) => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'books');
            await addDoc(colRef, bookData);
        };

        // Real-time Books Listener
        window.subscribeToBooks = (callback) => {
            // We only subscribe if we have a user (even anonymous)
            // The caller should ensure auth is ready, or we wait for it here implicitly by being called after init
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'books');
            return onSnapshot(colRef, (snapshot) => {
                const books = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                callback(books);
            }, (error) => {
                console.error("Error fetching books:", error);
            });
        };
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        dark: '#0F172A',
                        darker: '#020617',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3B82F6; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2563EB; }

        .loading-o {
            display: inline-block;
            width: 1em; height: 1em;
            border: 3px solid #3B82F6;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            vertical-align: middle; margin: 0 2px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-click { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-click:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-darker dark:text-white transition-colors duration-300 min-h-screen flex flex-col font-sans selection:bg-blue-500 selection:text-white">

    <!-- Sound -->
    <audio id="clickSound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="></audio> 

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 z-50 bg-white dark:bg-darker flex items-center justify-center transition-opacity duration-500">
        <div class="text-4xl font-bold tracking-widest font-serif">
            L<span class="loading-o"></span>ADING
        </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed w-full z-40 bg-white/80 dark:bg-darker/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 cursor-pointer btn-click" onclick="playSound(); appState.view='home'; render();">
                    <i class="ph-fill ph-book-open-text text-3xl text-blue-500"></i>
                    <span class="font-serif font-bold text-xl tracking-tight">Blue<span class="text-blue-500">Reader</span></span>
                </div>

                <div class="flex items-center gap-4">
                    <div id="adminControls" class="hidden">
                        <button onclick="showAdminModal()" class="px-3 py-1 bg-red-500/10 text-red-500 border border-red-500/20 rounded-full text-xs font-bold uppercase tracking-wider hover:bg-red-500 hover:text-white transition-colors btn-click">
                            + Add Book
                        </button>
                    </div>

                    <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 btn-click text-blue-500" onclick="toggleTheme()">
                        <i class="ph-fill ph-moon text-xl" id="themeIcon"></i>
                    </button>
                    
                    <div id="authButtons"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-20 flex-grow relative">
        
        <!-- View: Landing -->
        <div id="viewLanding" class="hidden">
            <section class="relative overflow-hidden px-4 py-20 sm:px-6 lg:px-8 flex flex-col items-center text-center">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-blue-500 via-transparent to-transparent"></div>
                <h1 class="text-5xl md:text-7xl font-serif font-bold mb-6 leading-tight">
                    Read <span class="text-blue-500">More</span>. <br> Scroll Less.
                </h1>
                <p class="text-lg md:text-xl text-gray-600 dark:text-gray-400 max-w-2xl mb-10">
                    Access a curated library of premium PDF books. Sync your progress.
                </p>
                <button onclick="playSound(); showAuthModal()" class="group relative inline-flex items-center justify-center px-8 py-3 text-lg font-medium text-white bg-blue-600 rounded-full overflow-hidden shadow-lg shadow-blue-500/40 btn-click hover:bg-blue-700">
                    <span class="mr-2">Start Reading Free</span>
                    <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </section>

            <section class="max-w-7xl mx-auto px-4 pb-20">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold font-serif">Trending Now</h2>
                    <span class="text-sm text-gray-500">Login to read</span>
                </div>
                <div id="publicGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </section>
        </div>

        <!-- View: Dashboard -->
        <div id="viewDashboard" class="hidden max-w-7xl mx-auto px-4 py-8">
            <div id="continueRow" class="mb-12 hidden">
                <h2 class="text-2xl font-bold font-serif mb-4 flex items-center gap-2">
                    <i class="ph-fill ph-clock-counter-clockwise text-blue-500"></i> Continue Reading
                </h2>
                <div class="flex overflow-x-auto gap-6 pb-4 snap-x scrollbar-hide" id="continueContainer"></div>
            </div>

            <div class="flex flex-wrap gap-2 mb-8" id="genreTags"></div>

            <h2 class="text-2xl font-bold font-serif mb-6">Library</h2>
            <div id="libraryGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
        </div>
    </main>

    <!-- Modal: Auth -->
    <div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md transform scale-95 transition-transform duration-300 relative border border-gray-200 dark:border-gray-700">
            <button onclick="hideAuthModal()" class="absolute top-4 right-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full btn-click">
                <i class="ph-bold ph-x"></i>
            </button>
            <div class="text-center mb-8">
                <h3 class="text-2xl font-bold font-serif mb-2">Welcome Back</h3>
            </div>
            <div class="space-y-4">
                <button onclick="handleGoogleLogin()" class="w-full py-3 px-4 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 dark:hover:bg-gray-600 btn-click transition-colors text-sm font-medium">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                    Continue with Google
                </button>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">OR</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>
                <form id="emailForm" class="space-y-4" onsubmit="handleEmailAuth(event)">
                    <input type="email" id="emailInput" placeholder="Email address" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    <input type="password" id="passInput" placeholder="Password" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-xl font-medium shadow-lg shadow-blue-500/30 hover:bg-blue-700 btn-click">Sign In / Sign Up</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Admin Add Book -->
    <div id="adminModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg transform scale-95 transition-transform duration-300 relative border border-gray-200 dark:border-gray-700">
            <button onclick="hideAdminModal()" class="absolute top-4 right-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full btn-click">
                <i class="ph-bold ph-x"></i>
            </button>
            <h3 class="text-xl font-bold font-serif mb-6">Add New Book</h3>
            <form onsubmit="submitNewBook(event)" class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Title</label>
                    <input type="text" id="newBookTitle" required class="w-full px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Author</label>
                    <input type="text" id="newBookAuthor" required class="w-full px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Genre</label>
                    <input type="text" id="newBookGenre" required class="w-full px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Cover Image URL</label>
                    <input type="url" id="newBookCover" required class="w-full px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">PDF URL (OneDrive/Direct)</label>
                    <input type="url" id="newBookPdf" required class="w-full px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button type="submit" class="w-full mt-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 btn-click">
                    Add to Library
                </button>
            </form>
        </div>
    </div>

    <!-- Modal: PDF Reader -->
    <div id="readerModal" class="fixed inset-0 z-50 bg-gray-900 hidden flex flex-col">
        <div class="h-14 bg-gray-800 flex items-center justify-between px-4 shadow-lg">
            <button onclick="closeReader()" class="text-gray-300 hover:text-white flex items-center gap-2 btn-click">
                <i class="ph-bold ph-arrow-left"></i> Back
            </button>
            <h4 id="readerTitle" class="text-white font-medium truncate max-w-[200px]">Book Title</h4>
            <div class="flex items-center gap-3">
                <button id="readerFavBtn" onclick="toggleReaderFav()" class="text-gray-400 hover:text-red-500 btn-click">
                    <i class="ph-fill ph-heart text-xl"></i>
                </button>
                <span class="text-xs text-gray-400 px-2 py-1 border border-gray-600 rounded">View Only</span>
            </div>
        </div>
        <div class="flex-grow bg-gray-500 relative overflow-hidden flex justify-center">
            <div class="w-full max-w-5xl h-full bg-white shadow-2xl relative">
                <iframe id="pdfFrame" class="w-full h-full" src=""></iframe>
                <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900/90 text-white px-6 py-3 rounded-full flex items-center gap-4 backdrop-blur-md shadow-xl">
                    <span class="text-sm font-medium">Page Tracker</span>
                    <input type="number" id="pageInput" class="w-16 bg-gray-700 border-none rounded text-center text-sm" value="1" min="1">
                    <button onclick="saveCurrentPage()" class="text-blue-400 text-xs uppercase font-bold tracking-wider hover:text-blue-300 btn-click">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // REPLACE THIS WITH YOUR EMAIL TO SEE ADMIN PANEL
        const adminEmails = ["your-email@gmail.com"]; 

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = 'sine'; o.frequency.setValueAtTime(800, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.05);
        }

        // --- DATA: BOOKS ---
        // Initial static books for demo + will merge with Firestore books
        const staticBooks = [
            {
                id: 'b1', title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', genre: 'Classic',
                cover: 'https://upload.wikimedia.org/wikipedia/commons/7/7a/The_Great_Gatsby_Cover_1925_Retouched.jpg',
                pdfUrl: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'
            },
            {
                id: 'b2', title: 'Pride and Prejudice', author: 'Jane Austen', genre: 'Romance',
                cover: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/PrideAndPrejudiceTitlePage.jpg/800px-PrideAndPrejudiceTitlePage.jpg',
                pdfUrl: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'
            }
        ];

        // --- STATE ---
        let appState = {
            user: null,
            view: 'landing',
            theme: 'light',
            progress: {},
            favorites: [],
            currentBook: null,
            books: [...staticBooks] // Combined list
        };

        // --- DOM ---
        const els = {
            loading: document.getElementById('loadingScreen'),
            themeIcon: document.getElementById('themeIcon'),
            authButtons: document.getElementById('authButtons'),
            adminControls: document.getElementById('adminControls'),
            viewLanding: document.getElementById('viewLanding'),
            viewDashboard: document.getElementById('viewDashboard'),
            authModal: document.getElementById('authModal'),
            adminModal: document.getElementById('adminModal'),
            publicGrid: document.getElementById('publicGrid'),
            libraryGrid: document.getElementById('libraryGrid'),
            continueRow: document.getElementById('continueRow'),
            continueContainer: document.getElementById('continueContainer'),
            genreTags: document.getElementById('genreTags'),
            readerModal: document.getElementById('readerModal'),
            pdfFrame: document.getElementById('pdfFrame'),
            readerTitle: document.getElementById('readerTitle'),
            pageInput: document.getElementById('pageInput'),
            readerFavBtn: document.getElementById('readerFavBtn')
        };

        // --- INIT ---
        window.onload = () => {
            setTimeout(() => {
                els.loading.classList.add('opacity-0');
                setTimeout(() => els.loading.classList.add('hidden'), 500);
            }, 1500);

            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                appState.theme = 'dark';
                document.documentElement.classList.add('dark');
            }
            updateThemeIcon();
        };

        // Subscribe to Dynamic Books immediately
        const bookInterval = setInterval(() => {
            if (window.subscribeToBooks) {
                clearInterval(bookInterval);
                window.subscribeToBooks((firestoreBooks) => {
                    // Merge static and firestore books
                    appState.books = [...staticBooks, ...firestoreBooks];
                    render(); // Re-render whenever books change
                });
            }
        }, 500);

        const authInterval = setInterval(() => {
            if (window.auth) {
                clearInterval(authInterval);
                window.auth.onAuthStateChanged(async (user) => {
                    appState.user = user;
                    // We now distinguish between Anonymous (Guest) and Registered users
                    if (user && !user.isAnonymous) {
                        appState.view = 'dashboard';
                        await loadUserData();
                    } else {
                        appState.view = 'landing';
                        appState.progress = {};
                    }
                    render();
                });
            }
        }, 100);

        // --- FUNCTIONS ---

        function toggleTheme() {
            playSound();
            appState.theme = appState.theme === 'light' ? 'dark' : 'light';
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', appState.theme);
            updateThemeIcon();
        }
        function updateThemeIcon() {
            els.themeIcon.className = appState.theme === 'dark' ? 'ph-fill ph-sun text-xl' : 'ph-fill ph-moon text-xl';
        }

        function render() {
            // Admin Check (Only for real users)
            if (appState.user && !appState.user.isAnonymous && adminEmails.includes(appState.user.email)) {
                els.adminControls.classList.remove('hidden');
            } else {
                els.adminControls.classList.add('hidden');
            }

            // Auth State (Show UI based on Real user, not anonymous)
            if (appState.user && !appState.user.isAnonymous) {
                els.authButtons.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${appState.user.photoURL || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + appState.user.email}" class="w-8 h-8 rounded-full border border-gray-300">
                        <button onclick="playSound(); window.logout()" class="text-sm font-medium text-red-500 hover:text-red-600 btn-click">Logout</button>
                    </div>
                `;
                els.viewLanding.classList.add('hidden');
                els.viewDashboard.classList.remove('hidden');
                renderDashboard();
            } else {
                els.authButtons.innerHTML = `
                    <button onclick="playSound(); showAuthModal()" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 btn-click shadow-md shadow-blue-500/20">Login</button>
                `;
                els.viewLanding.classList.remove('hidden');
                els.viewDashboard.classList.add('hidden');
                renderPublicGrid(); // Render public grid if logged out (uses anon auth for data)
            }
        }

        function getBookCardHTML(book, isPublic = false) {
            const onclick = isPublic ? `playSound(); openBook('${book.id}')` : `openBook('${book.id}')`;
            // Safety check for properties
            const cover = book.cover || 'https://placehold.co/200x300?text=No+Cover';
            const title = book.title || 'Untitled';
            const author = book.author || 'Unknown';

            return `
                <div onclick="${onclick}" class="group cursor-pointer btn-click">
                    <div class="aspect-[2/3] rounded-xl overflow-hidden shadow-lg mb-3 relative bg-gray-200 dark:bg-gray-700">
                        <img src="${cover}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" onerror="this.src='https://placehold.co/200x300?text=Error'">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                        ${!isPublic && appState.progress[book.id] ? `
                            <div class="absolute bottom-0 left-0 w-full h-1 bg-gray-700">
                                <div class="h-full bg-blue-500" style="width: ${Math.min(100, (appState.progress[book.id].page / 200) * 100)}%"></div>
                            </div>
                        ` : ''}
                    </div>
                    <h3 class="font-bold text-gray-900 dark:text-white leading-tight truncate">${title}</h3>
                    <p class="text-sm text-gray-500 truncate">${author}</p>
                </div>
            `;
        }

        function renderPublicGrid() {
            els.publicGrid.innerHTML = appState.books.map(b => getBookCardHTML(b, true)).join('');
        }

        function renderDashboard() {
            // Genres
            const genres = ['All', ...new Set(appState.books.map(b => b.genre || 'Misc'))];
            els.genreTags.innerHTML = genres.map(g => `
                <button class="px-4 py-1 rounded-full border border-gray-200 dark:border-gray-700 text-sm hover:bg-blue-50 dark:hover:bg-gray-800 hover:text-blue-500 btn-click transition-colors">${g}</button>
            `).join('');

            // Continue Reading
            const continueBooks = appState.books.filter(b => appState.progress[b.id]);
            if (continueBooks.length > 0) {
                els.continueRow.classList.remove('hidden');
                els.continueContainer.innerHTML = continueBooks.map(book => `
                    <div onclick="openBook('${book.id}')" class="min-w-[140px] w-[140px] snap-start cursor-pointer btn-click flex-shrink-0">
                        <div class="aspect-[2/3] rounded-lg overflow-hidden shadow-md relative mb-2">
                            <img src="${book.cover}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex items-end p-3">
                                <div class="text-white text-xs font-medium">Pg ${appState.progress[book.id].page}</div>
                            </div>
                        </div>
                        <h4 class="text-sm font-medium truncate dark:text-gray-200">${book.title}</h4>
                    </div>
                `).join('');
            } else {
                els.continueRow.classList.add('hidden');
            }

            // Library
            els.libraryGrid.innerHTML = appState.books.map(b => getBookCardHTML(b, false)).join('');
        }

        // --- MODALS & AUTH ---
        function showAuthModal() {
            els.authModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                els.authModal.classList.remove('opacity-0');
                els.authModal.children[0].classList.remove('scale-95');
                els.authModal.children[0].classList.add('scale-100');
            });
        }
        function hideAuthModal() {
            els.authModal.classList.add('opacity-0');
            els.authModal.children[0].classList.add('scale-95');
            setTimeout(() => els.authModal.classList.add('hidden'), 300);
        }
        function showAdminModal() {
            els.adminModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                els.adminModal.classList.remove('opacity-0');
                els.adminModal.children[0].classList.remove('scale-95');
                els.adminModal.children[0].classList.add('scale-100');
            });
        }
        function hideAdminModal() {
            els.adminModal.classList.add('opacity-0');
            els.adminModal.children[0].classList.add('scale-95');
            setTimeout(() => els.adminModal.classList.add('hidden'), 300);
        }

        async function handleGoogleLogin() {
            try { await window.loginGoogle(); hideAuthModal(); } 
            catch (err) { alert(err.message); }
        }
        async function handleEmailAuth(e) {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passInput').value;
            try { await window.loginEmail(email, pass); hideAuthModal(); } 
            catch (err) {
                if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                    try { await window.signupEmail(email, pass); hideAuthModal(); } 
                    catch (signupErr) { alert("Error: " + signupErr.message); }
                } else { alert(err.message); }
            }
        }

        async function submitNewBook(e) {
            e.preventDefault();
            const title = document.getElementById('newBookTitle').value;
            const author = document.getElementById('newBookAuthor').value;
            const genre = document.getElementById('newBookGenre').value;
            const cover = document.getElementById('newBookCover').value;
            let pdf = document.getElementById('newBookPdf').value;

            // Basic OneDrive Link cleaner
            if(pdf.includes("onedrive") && !pdf.includes("embed")) {
                alert("Tip: For OneDrive, please use the 'Embed' link, not the 'Share' link.");
            }

            const newBook = { title, author, genre, cover, pdfUrl: pdf, createdAt: new Date().toISOString() };
            
            try {
                await window.addBookToDB(newBook);
                hideAdminModal();
                e.target.reset();
                alert("Book Added!");
            } catch(err) {
                alert("Failed to add book: " + err.message);
            }
        }

        async function loadUserData() {
            if (!appState.user) return;
            try {
                const q = window.db.collection(window.db.getFirestore(window.app), 'artifacts', window.appId, 'users', appState.user.uid, 'progress');
                // Mock loading logic for demo
            } catch(e) { console.log("Firestore init needed"); }
        }

        // --- READER ---
        function openBook(bookId) {
            playSound();

            // Check for anonymous (Guest) user
            // If user is not logged in or is anonymous, we prompt login
            if (!appState.user || appState.user.isAnonymous) {
                showAuthModal();
                return;
            }

            const book = appState.books.find(b => b.id === bookId);
            if (!book) return;
            appState.currentBook = book;
            els.readerTitle.innerText = book.title;
            els.pdfFrame.src = book.pdfUrl + "#toolbar=0&navpanes=0&scrollbar=0";
            const progress = appState.progress[bookId];
            els.pageInput.value = progress ? progress.page : 1;
            const isFav = appState.favorites.includes(bookId);
            els.readerFavBtn.innerHTML = isFav ? '<i class="ph-fill ph-heart text-red-500 text-xl"></i>' : '<i class="ph-fill ph-heart text-xl"></i>';
            els.readerModal.classList.remove('hidden');
        }
        function closeReader() {
            playSound();
            els.readerModal.classList.add('hidden');
            els.pdfFrame.src = "";
            appState.currentBook = null;
            render();
        }
        async function saveCurrentPage() {
            playSound();
            const page = parseInt(els.pageInput.value);
            const bookId = appState.currentBook.id;
            appState.progress[bookId] = { page: page, lastRead: new Date() };
            await window.saveBookProgress(bookId, page);
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "SAVED";
            setTimeout(() => btn.innerText = originalText, 1500);
        }
        async function toggleReaderFav() {
            playSound();
            if(!appState.currentBook) return;
            const id = appState.currentBook.id;
            if (appState.favorites.includes(id)) {
                appState.favorites = appState.favorites.filter(fid => fid !== id);
                els.readerFavBtn.innerHTML = '<i class="ph-fill ph-heart text-xl"></i>';
            } else {
                appState.favorites.push(id);
                els.readerFavBtn.innerHTML = '<i class="ph-fill ph-heart text-red-500 text-xl"></i>';
            }
            await window.toggleFav(id);
        }
    </script>
</body>
</html>