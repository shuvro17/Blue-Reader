<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlueReader | Fluid UI</title>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #6366f1;
        --secondary: #a855f7;
        --accent: #ec4899;

        /* Glass Vars */
        --glass-bg: rgba(255, 255, 255, 0.65);
        --glass-border: rgba(255, 255, 255, 0.5);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);

        /* Text Vars */
        --text-main: #0f172a;
        --text-muted: #475569;

        /* Input Vars (Light Mode Default) */
        --input-bg: rgba(255, 255, 255, 0.9);
        --input-text: #1e293b;
        --input-border: #cbd5e1;

        --radius-lg: 24px;
        --radius-md: 16px;
      }

      .dark-mode {
        --glass-bg: rgba(15, 23, 42, 0.6);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-main: #f8fafc;
        --text-muted: #cbd5e1;
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);

        /* Input Vars (Dark Mode) */
        --input-bg: rgba(2, 6, 23, 0.6);
        --input-text: #f1f5f9;
        --input-border: #334155;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Plus Jakarta Sans", sans-serif;
      }

      body {
        background: #f0f2f5;
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
        transition: color 0.3s ease, background 0.3s ease;
      }
      .dark-mode body {
        background: #020617;
      }

      /* --- ðŸŒŠ FLUID BACKGROUND ANIMATION --- */
      .background-fluid {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        background: linear-gradient(145deg, #e0e7ff, #f3e8ff);
      }
      .dark-mode .background-fluid {
        background: #020617;
      }

      .blob {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.6;
        animation: float 20s infinite ease-in-out alternate;
      }
      .blob-1 {
        width: 500px;
        height: 500px;
        background: var(--primary);
        top: -10%;
        left: -10%;
        animation-delay: 0s;
      }
      .blob-2 {
        width: 400px;
        height: 400px;
        background: var(--secondary);
        bottom: 10%;
        right: -5%;
        animation-delay: -5s;
      }
      .blob-3 {
        width: 300px;
        height: 300px;
        background: var(--accent);
        top: 40%;
        left: 40%;
        animation-delay: -10s;
      }

      @keyframes float {
        0% {
          transform: translate(0, 0) scale(1);
        }
        33% {
          transform: translate(30px, -50px) scale(1.1);
        }
        66% {
          transform: translate(-20px, 20px) scale(0.9);
        }
        100% {
          transform: translate(0, 0) scale(1);
        }
      }

      /* --- Navbar --- */
      .navbar {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 1200px;
        height: 70px;
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-radius: 100px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        z-index: 100;
        box-shadow: var(--glass-shadow);
        transition: all 0.3s ease;
      }

      .logo {
        font-family: "Outfit", sans-serif;
        font-weight: 800;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-main);
        text-decoration: none;
      }
      .logo i {
        color: var(--primary);
      }

      .nav-links {
        display: flex;
        gap: 10px;
      }
      .nav-btn {
        padding: 10px 20px;
        border-radius: 100px;
        text-decoration: none;
        color: var(--text-muted);
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }
      .nav-btn:hover {
        color: var(--primary);
        background: rgba(255, 255, 255, 0.2);
      }
      .nav-btn.active {
        background: var(--text-main);
        color: #fff !important;
      }
      .dark-mode .nav-btn.active {
        background: #fff;
        color: #000 !important;
      }

      .nav-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .icon-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-main);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: 0.3s;
      }
      .icon-btn:hover {
        background: var(--primary);
        color: white;
        transform: rotate(15deg);
      }

      /* --- Main Layout --- */
      .main-container {
        max-width: 1200px;
        margin: 120px auto 40px;
        padding: 0 20px;
      }
      .page-view {
        display: none;
        animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .page-view.active {
        display: block;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- Hero Banner --- */
      .hero-banner {
        width: 100%;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.3);
        border: 1px solid var(--glass-border);
        padding: 40px;
        margin-bottom: 50px;
        display: flex;
        align-items: center;
        gap: 40px;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }
      .dark-mode .hero-banner {
        background: rgba(0, 0, 0, 0.3);
      }

      .hero-content {
        flex: 1;
        z-index: 2;
      }
      .hero-badge {
        display: inline-block;
        padding: 6px 12px;
        background: var(--primary);
        color: white;
        border-radius: 100px;
        font-size: 0.8rem;
        font-weight: 700;
        margin-bottom: 15px;
      }
      .hero-title {
        font-family: "Outfit", sans-serif;
        font-size: 3rem;
        font-weight: 800;
        line-height: 1.1;
        margin-bottom: 15px;
      }
      .hero-desc {
        font-size: 1.1rem;
        color: var(--text-muted);
        margin-bottom: 25px;
        max-width: 500px;
      }
      .hero-img {
        width: 200px;
        height: 300px;
        object-fit: cover;
        border-radius: var(--radius-md);
        transform: rotate(-5deg);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        z-index: 2;
        transition: 0.3s;
      }
      .hero-img:hover {
        transform: rotate(0deg) scale(1.05);
      }

      /* --- Filters --- */
      .filters {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 10px;
      }
      .filter-pill {
        padding: 8px 20px;
        border-radius: 100px;
        border: 1px solid var(--glass-border);
        background: var(--glass-bg);
        color: var(--text-muted);
        cursor: pointer;
        font-weight: 600;
        white-space: nowrap;
        transition: 0.3s;
      }
      .filter-pill.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* --- Grid --- */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 30px;
      }

      .book-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        padding: 15px;
        position: relative;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
      }
      .book-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
      }

      .card-img {
        width: 100%;
        aspect-ratio: 2/3;
        object-fit: cover;
        border-radius: 12px;
        margin-bottom: 15px;
      }
      .card-title {
        font-family: "Outfit", sans-serif;
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .card-author {
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .fav-btn-card {
        position: absolute;
        top: 25px;
        right: 25px;
        background: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ef4444;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      /* --- Inputs --- */
      .input-group {
        margin-bottom: 20px;
      }
      .glass-input {
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        background: var(--input-bg);
        color: var(--input-text);
        border: 1px solid var(--input-border);
        outline: none;
        transition: 0.3s;
        font-size: 0.95rem;
      }
      .glass-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      }

      .btn-main {
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        border: none;
        background: var(--text-main);
        color: var(--input-bg);
        font-weight: 700;
        cursor: pointer;
        transition: 0.3s;
      }
      .btn-main:hover {
        transform: scale(1.02);
        opacity: 0.9;
      }

      /* --- Admin Panel --- */
      .admin-panel {
        background: var(--glass-bg);
        padding: 40px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--glass-border);
        max-width: 600px;
        margin: 0 auto;
      }

      /* --- Modern Auth Modal (Fixed) --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        z-index: 200;
        display: none;
        align-items: center;
        justify-content: center;
        /* FIX: Makes background clickable */
        cursor: pointer;
      }
      .modal-overlay.active {
        display: flex;
      }

      .auth-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        width: 100%;
        max-width: 420px;
        padding: 40px;
        border-radius: 24px;
        box-shadow: var(--glass-shadow);
        position: relative;
        text-align: center;
        animation: popIn 0.3s ease;
        /* FIX: Prevents background clicks from affecting the card */
        cursor: default;
      }

      @keyframes popIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .auth-title {
        font-family: "Outfit", sans-serif;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
      }
      .auth-subtitle {
        color: var(--text-muted);
        margin-bottom: 30px;
        font-size: 0.95rem;
      }

      .btn-google {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--input-border);
        background: #ffffff;
        color: #1f2937;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        transition: 0.2s;
      }
      .btn-google:hover {
        background: #f9fafb;
        border-color: #9ca3af;
      }
      .dark-mode .btn-google {
        background: #1e293b;
        color: white;
        border-color: #334155;
      }
      .dark-mode .btn-google:hover {
        background: #334155;
      }

      .divider {
        display: flex;
        align-items: center;
        gap: 15px;
        color: var(--text-muted);
        font-size: 0.8rem;
        margin-bottom: 20px;
      }
      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--glass-border);
      }

      .btn-primary {
        width: 100%;
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }
      .btn-primary:hover {
        background: #4f46e5;
      }

      /* --- Reader View --- */
      .reader-view {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--glass-bg);
        z-index: 300;
        display: none;
        flex-direction: column;
      }
      .reader-top {
        height: 70px;
        padding: 0 30px;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
      }

      /* --- Mobile Tweaks --- */
      .mobile-nav {
        display: none;
      }
      @media (max-width: 768px) {
        .navbar {
          top: auto;
          bottom: 20px;
          padding: 0 20px;
          justify-content: space-around;
          height: 65px;
        }
        .nav-links,
        .logo span,
        .nav-actions {
          display: none;
        }
        .mobile-nav {
          display: contents;
        }
        .mobile-icon {
          font-size: 1.5rem;
          color: var(--text-muted);
          cursor: pointer;
        }
        .mobile-icon.active {
          color: var(--primary);
        }
        .main-container {
          margin-top: 40px;
          padding-bottom: 100px;
        }
        .hero-banner {
          flex-direction: column-reverse;
          text-align: center;
          padding: 25px;
        }
        .hero-img {
          margin-bottom: 20px;
          width: 140px;
          height: 210px;
        }
      }
    </style>
  </head>
  <body>
    <div class="background-fluid">
      <div class="blob blob-1"></div>
      <div class="blob blob-2"></div>
      <div class="blob blob-3"></div>
    </div>

    <nav class="navbar">
      <a href="#home" class="logo"
        ><i class="ph-fill ph-flying-saucer"></i> <span>BlueReader</span></a
      >

      <div class="nav-links">
        <a href="#home" class="nav-btn active">Discover</a>
        <a href="#library" class="nav-btn">Library</a>
        <a href="#continue" class="nav-btn">Continue</a>
        <a href="#admin" class="nav-btn" id="nav-admin" style="display: none"
          >Admin</a
        >
      </div>

      <div class="nav-actions">
        <button class="icon-btn" onclick="app.toggleTheme()">
          <i class="ph-fill ph-moon" id="themeIcon"></i>
        </button>
        <button
          class="nav-btn"
          style="background: var(--primary); color: white"
          id="authBtn"
          onclick="app.handleAuth()"
        >
          Sign In
        </button>
      </div>

      <i
        class="ph-bold ph-compass mobile-icon active"
        onclick="location.hash='#home'"
      ></i>
      <i
        class="ph-bold ph-books mobile-icon"
        onclick="location.hash='#library'"
      ></i>
      <i
        class="ph-bold ph-clock-counter-clockwise mobile-icon"
        onclick="location.hash='#continue'"
      ></i>
      <i
        class="ph-bold ph-user-circle mobile-icon"
        onclick="app.handleAuth()"
      ></i>
    </nav>

    <div class="main-container">
      <div id="page-home" class="page-view active">
        <div class="hero-banner" id="homeBanner">
          <div class="hero-content">
            <span class="hero-badge">FEATURED READ</span>
            <h1 class="hero-title">The Great Gatsby</h1>
            <p class="hero-desc">
              Immerse yourself in the roaring twenties with F. Scott
              Fitzgerald's timeless masterpiece of obsession and dreams.
            </p>
            <button
              class="nav-btn"
              style="background: var(--text-main); color: var(--glass-bg)"
              onclick="app.openReader('b1')"
            >
              Read Now
            </button>
          </div>
          <img
            src="https://upload.wikimedia.org/wikipedia/commons/7/7a/The_Great_Gatsby_Cover_1925_Retouched.jpg"
            class="hero-img"
            alt="Featured"
          />
        </div>

        <div class="filters" id="genreFilters"></div>

        <div class="grid" id="publicGrid"></div>
      </div>

      <div id="page-library" class="page-view">
        <h1 style="font-family: 'Outfit'; font-size: 2rem; margin-bottom: 20px">
          My Collection
        </h1>
        <div class="grid" id="libraryGrid"></div>
      </div>

      <div id="page-continue" class="page-view">
        <h1 style="font-family: 'Outfit'; font-size: 2rem; margin-bottom: 20px">
          Jump Back In
        </h1>
        <div class="grid" id="continueGrid"></div>
      </div>

      <div id="page-admin" class="page-view">
        <div class="admin-panel">
          <h2 style="margin-bottom: 20px; font-family: 'Outfit'">
            Add New Book
          </h2>
          <form onsubmit="app.addBook(event)">
            <div class="input-group">
              <input
                id="nTitle"
                class="glass-input"
                placeholder="Book Title"
                required
              />
            </div>
            <div class="input-group">
              <input
                id="nAuthor"
                class="glass-input"
                placeholder="Author"
                required
              />
            </div>
            <div class="input-group">
              <input
                id="nGenre"
                class="glass-input"
                placeholder="Genre"
                required
              />
            </div>
            <div class="input-group">
              <input
                id="nCover"
                class="glass-input"
                placeholder="Cover Image URL"
                required
              />
            </div>
            <div class="input-group">
              <input
                id="nPdf"
                class="glass-input"
                placeholder="PDF URL"
                required
              />
            </div>
            <button type="submit" class="btn-main">Publish to Library</button>
          </form>
        </div>
      </div>
    </div>

    <div class="reader-view" id="readerView">
      <div class="reader-top">
        <button class="icon-btn" onclick="app.closeReader()">
          <i class="ph-bold ph-arrow-left"></i>
        </button>
        <span style="font-weight: 700" id="readerTitle">Book</span>
        <div style="display: flex; gap: 10px">
          <button class="icon-btn" id="readerFav" onclick="app.toggleFav()">
            <i class="ph-heart"></i>
          </button>
          <input
            type="number"
            id="pageInput"
            class="glass-input"
            style="width: 70px; padding: 8px"
            value="1"
            onchange="app.updatePage()"
          />
          <button
            class="nav-btn"
            style="background: var(--primary); color: white; padding: 8px 20px"
            onclick="app.saveProgress()"
          >
            Save
          </button>
        </div>
      </div>
      <iframe id="pdfFrame" style="flex: 1; border: none" src=""></iframe>
    </div>

    <div
      class="modal-overlay"
      id="authModal"
      onclick="app.closeModal('authModal')"
    >
      <div class="auth-card" onclick="event.stopPropagation()">
        <button
          style="
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
          "
          onclick="app.closeModal('authModal')"
        >
          <i class="ph-x" style="font-size: 1.5rem; padding: 5px"></i>
        </button>

        <h1 class="auth-title">Welcome Back</h1>
        <p class="auth-subtitle">Sign in to access your personal library.</p>

        <button class="btn-google" onclick="api.loginGoogle()">
          <img
            src="https://www.svgrepo.com/show/475656/google-color.svg"
            alt="Google"
            style="width: 20px"
          />
          Continue with Google
        </button>

        <div class="divider">OR LOGIN WITH EMAIL</div>

        <form onsubmit="app.emailLogin(event)">
          <div class="input-group">
            <input
              id="emailIn"
              class="glass-input"
              type="email"
              placeholder="Email Address"
              required
            />
          </div>
          <div class="input-group">
            <input
              id="passIn"
              class="glass-input"
              type="password"
              placeholder="Password"
              required
            />
          </div>
          <button class="btn-primary" style="width: 100%">Sign In</button>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        updateDoc,
        arrayUnion,
        arrayRemove,
        collection,
        onSnapshot,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

      // --- CONFIG ---
      // !!! REPLACE WITH YOUR EMAIL FOR ADMIN ACCESS !!!
      const ADMIN_EMAILS = ["tanvirrshuvro@gmail.com"];

      const firebaseConfig = {
        apiKey: "AIzaSyCh6YZVCawcGfyPz6s1K9DJqBeIC-c7Hsw",
        authDomain: "readersparadize-85e8e.firebaseapp.com",
        projectId: "readersparadize-85e8e",
        storageBucket: "readersparadize-85e8e.firebasestorage.app",
        messagingSenderId: "168539796198",
        appId: "1:168539796198:web:d01f9b7915292e6c5fc127",
      };

      const fb = initializeApp(firebaseConfig);
      const auth = getAuth(fb);
      const db = getFirestore(fb);
      const APP_ID = "blue-fluid-v2";

      window.api = {
        loginGoogle: () =>
          signInWithPopup(auth, new GoogleAuthProvider()).then(() =>
            app.closeModal("authModal")
          ),
        loginEmail: (e, p) => signInWithEmailAndPassword(auth, e, p),
        signupEmail: (e, p) => createUserWithEmailAndPassword(auth, e, p),
        logout: () => signOut(auth),
      };

      const state = {
        user: null,
        books: [
          {
            id: "b1",
            title: "The Great Gatsby",
            author: "F. Scott Fitzgerald",
            genre: "Classic",
            cover:
              "https://upload.wikimedia.org/wikipedia/commons/7/7a/The_Great_Gatsby_Cover_1925_Retouched.jpg",
            pdfUrl:
              "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
          },
          {
            id: "b2",
            title: "Pride and Prejudice",
            author: "Jane Austen",
            genre: "Romance",
            cover:
              "https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/PrideAndPrejudiceTitlePage.jpg/800px-PrideAndPrejudiceTitlePage.jpg",
            pdfUrl:
              "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
          },
          {
            id: "b3",
            title: "1984",
            author: "George Orwell",
            genre: "Sci-Fi",
            cover:
              "https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1676649712i/1984._SY75_.jpg",
            pdfUrl:
              "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
          },
        ],
        progress: {},
        favs: [],
        filter: "All",
        currentBook: null,
      };

      window.app = {
        init: () => {
          window.addEventListener("hashchange", app.router);
          onAuthStateChanged(auth, (u) => {
            state.user = u;
            if (!u) signInAnonymously(auth);
            else if (!u.isAnonymous) {
              // Sync Data
              onSnapshot(
                collection(db, "artifacts", APP_ID, "users", u.uid, "progress"),
                (s) => {
                  s.docs.forEach((d) => (state.progress[d.id] = d.data()));
                  app.render();
                }
              );
              getDoc(
                doc(db, "artifacts", APP_ID, "users", u.uid, "prefs", "favs")
              ).then((s) => {
                if (s.exists()) state.favs = s.data().ids;
                app.render();
              });
            }
            app.updateUI();
          });

          // Live Books
          onSnapshot(
            collection(db, "artifacts", APP_ID, "public", "books"),
            (s) => {
              const live = s.docs.map((d) => ({ id: d.id, ...d.data() }));
              const ids = new Set(live.map((b) => b.id));
              state.books = [
                ...state.books.filter((b) => !ids.has(b.id)),
                ...live,
              ];
              app.render();
            }
          );

          if (!location.hash) location.hash = "#home";
          app.router();

          // Close modals on Esc
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") app.closeModal("authModal");
          });
        },

        router: () => {
          const hash = location.hash.slice(1) || "home";
          document
            .querySelectorAll(".page-view")
            .forEach((e) => e.classList.remove("active"));
          document.getElementById(`page-${hash}`).classList.add("active");

          // Update Nav
          document.querySelectorAll(".nav-btn").forEach((b) => {
            b.classList.toggle("active", b.getAttribute("href") === `#${hash}`);
          });

          // Mobile icons
          const icons = document.querySelectorAll(".mobile-icon");
          icons.forEach((i) => i.classList.remove("active"));
          if (hash === "home") icons[0].classList.add("active");
          if (hash === "library") icons[1].classList.add("active");
          if (hash === "continue") icons[2].classList.add("active");

          app.render();
        },

        updateUI: () => {
          const u = state.user && !state.user.isAnonymous;
          document.getElementById("authBtn").innerText = u
            ? "Sign Out"
            : "Sign In";
          document.getElementById("nav-admin").style.display =
            u && ADMIN_EMAILS.includes(state.user.email) ? "block" : "none";
        },

        render: () => {
          // Filters
          const genres = ["All", ...new Set(state.books.map((b) => b.genre))];
          document.getElementById("genreFilters").innerHTML = genres
            .map(
              (g) =>
                `<div class="filter-pill ${
                  state.filter === g ? "active" : ""
                }" onclick="app.setFilter('${g}')">${g}</div>`
            )
            .join("");

          // Home Grid
          const visible =
            state.filter === "All"
              ? state.books
              : state.books.filter((b) => b.genre === state.filter);
          document.getElementById("publicGrid").innerHTML = visible
            .map((b) => app.card(b))
            .join("");

          // Library
          const lib = state.books.filter((b) => state.favs.includes(b.id));
          document.getElementById("libraryGrid").innerHTML = lib.length
            ? lib.map((b) => app.card(b)).join("")
            : `<div style="grid-column:1/-1; text-align:center; color:var(--text-muted);">No favorites yet.</div>`;

          // Continue
          const cont = state.books.filter((b) => state.progress[b.id]);
          document.getElementById("continueGrid").innerHTML = cont.length
            ? cont.map((b) => app.card(b)).join("")
            : `<div style="grid-column:1/-1; text-align:center; color:var(--text-muted);">No active reads.</div>`;
        },

        card: (b) => {
          const isFav = state.favs.includes(b.id);
          return `
                <div class="book-card" onclick="app.openReader('${b.id}')">
                    <img src="${b.cover}" class="card-img">
                    ${
                      isFav
                        ? '<div class="fav-btn-card"><i class="ph-fill ph-heart"></i></div>'
                        : ""
                    }
                    <div class="card-title">${b.title}</div>
                    <div class="card-author">${b.author}</div>
                </div>`;
        },

        setFilter: (g) => {
          state.filter = g;
          app.render();
        },

        handleAuth: () => {
          if (state.user && !state.user.isAnonymous) api.logout();
          else document.getElementById("authModal").classList.add("active");
        },

        emailLogin: async (e) => {
          e.preventDefault();
          const em = document.getElementById("emailIn").value;
          const pw = document.getElementById("passIn").value;
          try {
            await api.loginEmail(em, pw);
            app.closeModal("authModal");
          } catch {
            try {
              await api.signupEmail(em, pw);
              app.closeModal("authModal");
            } catch (err) {
              alert(err.message);
            }
          }
        },

        closeModal: (id) =>
          document.getElementById(id).classList.remove("active"),

        addBook: async (e) => {
          e.preventDefault();
          if (!state.user || !ADMIN_EMAILS.includes(state.user.email)) {
            alert(
              "Access Denied: You are not authorized to add books. Please check the ADMIN_EMAILS list in the code."
            );
            return;
          }

          try {
            await addDoc(
              collection(db, "artifacts", APP_ID, "public", "books"),
              {
                title: document.getElementById("nTitle").value,
                author: document.getElementById("nAuthor").value,
                genre: document.getElementById("nGenre").value,
                cover: document.getElementById("nCover").value,
                pdfUrl: document.getElementById("nPdf").value,
              }
            );
            alert("Book successfully added to database!");
            e.target.reset();
          } catch (err) {
            alert(
              "Error adding book: " + err.message + "\nCheck Firestore rules."
            );
          }
        },

        openReader: (id) => {
          state.currentBook = state.books.find((b) => b.id === id);
          document.getElementById("readerTitle").innerText =
            state.currentBook.title;
          document.getElementById("readerView").style.display = "flex";
          document.getElementById("pdfFrame").src =
            state.currentBook.pdfUrl +
            (state.progress[id] ? `#page=${state.progress[id].page}` : "");
          app.updateFavBtn();
        },

        closeReader: () => {
          document.getElementById("readerView").style.display = "none";
          document.getElementById("pdfFrame").src = "";
        },

        updatePage: () => {
          const pg = document.getElementById("pageInput").value;
          document.getElementById("pdfFrame").src =
            state.currentBook.pdfUrl + `#page=${pg}`;
        },

        saveProgress: async () => {
          if (!state.user || state.user.isAnonymous)
            return alert("Please sign in to save.");
          const pg = document.getElementById("pageInput").value;
          await setDoc(
            doc(
              db,
              "artifacts",
              APP_ID,
              "users",
              state.user.uid,
              "progress",
              state.currentBook.id
            ),
            { page: pg, lastRead: new Date().toISOString() },
            { merge: true }
          );
          alert("Saved!");
        },

        toggleFav: async () => {
          if (!state.user || state.user.isAnonymous)
            return alert("Please sign in.");
          const ref = doc(
            db,
            "artifacts",
            APP_ID,
            "users",
            state.user.uid,
            "prefs",
            "favs"
          );
          const isFav = state.favs.includes(state.currentBook.id);
          await setDoc(
            ref,
            {
              ids: isFav
                ? arrayRemove(state.currentBook.id)
                : arrayUnion(state.currentBook.id),
            },
            { merge: true }
          );
          // Local update for speed
          if (isFav)
            state.favs = state.favs.filter((id) => id !== state.currentBook.id);
          else state.favs.push(state.currentBook.id);
          app.updateFavBtn();
          app.render();
        },

        updateFavBtn: () => {
          const isFav = state.favs.includes(state.currentBook.id);
          document.getElementById("readerFav").innerHTML = isFav
            ? '<i class="ph-fill ph-heart" style="color:#ec4899"></i>'
            : '<i class="ph-heart"></i>';
        },

        toggleTheme: () => {
          document.body.classList.toggle("dark-mode");
          document.getElementById("themeIcon").className =
            document.body.classList.contains("dark-mode")
              ? "ph-fill ph-sun"
              : "ph-fill ph-moon";
        },
      };

      window.onload = app.init;
    </script>
  </body>
</html>
