<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlueReader | Modern Library</title>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
      /* --- Fonts & Variables --- */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

      :root {
        /* Light Mode (Default) */
        --bg-body: #f8fafc; /* Slate 50 */
        --bg-surface: #ffffff;
        --bg-subtle: #f1f5f9; /* Slate 100 */

        --text-main: #0f172a; /* Slate 900 */
        --text-muted: #64748b; /* Slate 500 */
        --text-on-primary: #ffffff;

        --primary: #6366f1; /* Indigo 500 */
        --primary-hover: #4f46e5; /* Indigo 600 */

        --border: #e2e8f0; /* Slate 200 */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);

        --radius: 8px;
        --header-height: 64px;
      }

      /* Dark Mode Override */
      .dark-mode {
        --bg-body: #0f172a; /* Slate 900 */
        --bg-surface: #1e293b; /* Slate 800 */
        --bg-subtle: #334155; /* Slate 700 */

        --text-main: #f8fafc;
        --text-muted: #94a3b8;

        --primary: #818cf8; /* Indigo 400 */
        --primary-hover: #6366f1;

        --border: #334155;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3);
      }

      /* --- Reset & Base --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
      }

      body {
        background-color: var(--bg-body);
        color: var(--text-main);
        transition: background-color 0.3s ease, color 0.3s ease;
        padding-top: var(--header-height);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* --- Navigation Bar (Desktop) --- */
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--header-height);
        background-color: rgba(255, 255, 255, 0.8); /* Glass effect base */
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
      }
      .dark-mode .navbar {
        background-color: rgba(15, 23, 42, 0.8);
      }

      .nav-brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 1.25rem;
        color: var(--text-main);
        text-decoration: none;
      }
      .nav-brand i {
        color: var(--primary);
        font-size: 1.5rem;
      }

      .nav-links {
        display: flex;
        gap: 8px;
        height: 100%;
        align-items: center;
      }
      .nav-item {
        text-decoration: none;
        color: var(--text-muted);
        font-size: 0.9rem;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 99px; /* Pill shape */
        transition: all 0.2s;
      }
      .nav-item:hover {
        color: var(--primary);
        background-color: var(--bg-subtle);
      }
      .nav-item.active {
        color: var(--text-on-primary);
        background-color: var(--primary);
      }

      .nav-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      /* Theme Toggle */
      .icon-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
        width: 36px;
        height: 36px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .icon-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      /* Primary Button */
      .btn-primary {
        background-color: var(--primary);
        color: var(--text-on-primary);
        border: none;
        padding: 8px 16px;
        border-radius: var(--radius);
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
      }
      .btn-primary:hover {
        background-color: var(--primary-hover);
      }

      /* --- Page Container --- */
      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 24px;
        flex: 1;
      }

      /* Page Transitions */
      .page-view {
        display: none;
        animation: fadeUp 0.3s ease-out;
      }
      .page-view.active {
        display: block;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- Hero Section (Home) --- */
      .hero {
        text-align: center;
        margin-bottom: 48px;
        padding: 40px 20px;
        background: linear-gradient(
          135deg,
          var(--bg-subtle) 0%,
          var(--bg-surface) 100%
        );
        border-radius: 16px;
        border: 1px solid var(--border);
      }
      .hero h1 {
        font-size: 2.5rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: 12px;
        color: var(--text-main);
      }
      .hero p {
        font-size: 1.1rem;
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto 24px;
      }

      /* --- Filters (Modern Tags) --- */
      .filter-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 32px;
        justify-content: center;
      }
      .filter-tag {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        color: var(--text-muted);
        padding: 6px 16px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-tag:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .filter-tag.active {
        background: var(--bg-subtle);
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 600;
      }

      /* --- Book Grid --- */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 24px;
      }
      .book-card {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        transition: all 0.2s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .book-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
      }
      .book-cover-wrap {
        width: 100%;
        aspect-ratio: 2/3;
        overflow: hidden;
        background: var(--bg-subtle);
      }
      .book-cover {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
      }
      .book-card:hover .book-cover {
        transform: scale(1.05);
      }

      .book-info {
        padding: 16px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .book-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
        color: var(--text-main);
        line-height: 1.4;
      }
      .book-author {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 12px;
      }

      .progress-track {
        width: 100%;
        height: 4px;
        background: var(--bg-subtle);
        border-radius: 2px;
        margin-top: auto;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        background: var(--primary);
        width: 0%;
      }
      .fav-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ef4444;
        box-shadow: var(--shadow-sm);
      }

      /* --- Empty States --- */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--bg-subtle);
        border-radius: 16px;
        border: 1px dashed var(--border);
      }
      .empty-icon {
        font-size: 3rem;
        color: var(--text-muted);
        margin-bottom: 16px;
      }
      .empty-text {
        color: var(--text-muted);
        font-size: 1rem;
      }

      /* --- Modals --- */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 200;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-backdrop.active {
        display: flex;
      }
      .modal {
        background: var(--bg-surface);
        width: 100%;
        max-width: 420px;
        border-radius: 12px;
        padding: 32px;
        margin: 20px;
        box-shadow: var(--shadow-lg);
        position: relative;
        animation: scaleIn 0.2s ease;
      }
      @keyframes scaleIn {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        text-align: center;
      }
      .modal-desc {
        text-align: center;
        color: var(--text-muted);
        margin-bottom: 24px;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .input-field {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg-body);
        color: var(--text-main);
        outline: none;
        font-size: 0.95rem;
        transition: border-color 0.2s;
      }
      .input-field:focus {
        border-color: var(--primary);
        ring: 2px solid var(--primary);
      }
      .close-modal {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 1.2rem;
      }

      /* --- Reader View --- */
      .reader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-surface);
        z-index: 300;
        display: none;
        flex-direction: column;
      }
      .reader-toolbar {
        height: 60px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        background: var(--bg-surface);
      }
      .reader-frame {
        flex: 1;
        border: none;
        width: 100%;
      }

      /* --- Mobile Nav --- */
      .mobile-nav {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 64px;
        background: rgba(255, 255, 255, 0.95);
        border-top: 1px solid var(--border);
        backdrop-filter: blur(10px);
        z-index: 150;
        justify-content: space-around;
        align-items: center;
      }
      .dark-mode .mobile-nav {
        background: rgba(30, 41, 59, 0.95);
      }
      .mobile-link {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.75rem;
        font-weight: 500;
        background: none;
        border: none;
        cursor: pointer;
        width: 100%;
      }
      .mobile-link i {
        font-size: 1.4rem;
      }
      .mobile-link.active {
        color: var(--primary);
      }

      /* --- Responsive --- */
      @media (max-width: 768px) {
        .nav-links {
          display: none;
        } /* Hide desktop links */
        .navbar {
          justify-content: space-between;
        }
        .mobile-nav {
          display: flex;
        }
        .container {
          padding-bottom: 80px;
        } /* Space for bottom nav */
        .hero h1 {
          font-size: 1.8rem;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <a href="#home" class="nav-brand">
        <i class="ph-fill ph-books"></i> BlueReader
      </a>

      <div class="nav-links">
        <a href="#home" class="nav-item active">Discover</a>
        <a href="#library" class="nav-item">Library</a>
        <a href="#continue" class="nav-item">Continue</a>
        <a href="#admin" class="nav-item" id="nav-admin" style="display: none"
          >Admin</a
        >
      </div>

      <div class="nav-actions">
        <button
          class="icon-btn"
          onclick="window.app.toggleTheme()"
          aria-label="Toggle Theme"
        >
          <i class="ph-fill ph-moon" id="themeIcon"></i>
        </button>
        <button
          class="btn-primary"
          id="desktopAuthBtn"
          onclick="window.app.handleAuthClick()"
        >
          Sign In
        </button>
      </div>
    </nav>

    <div class="container">
      <div id="page-home" class="page-view active">
        <div class="hero">
          <h1>Explore a World of Knowledge</h1>
          <p>
            Access a curated collection of classic literature and modern
            insights. Free, fast, and accessible anywhere.
          </p>
        </div>

        <div class="filter-container" id="genreTabs"></div>

        <div class="grid" id="publicGrid"></div>
      </div>

      <div id="page-library" class="page-view">
        <div style="margin-bottom: 24px">
          <h2 style="font-size: 1.8rem; color: var(--text-main)">My Library</h2>
          <p style="color: var(--text-muted)">
            Your personal collection of saved books.
          </p>
        </div>
        <div class="grid" id="libraryGrid"></div>
      </div>

      <div id="page-continue" class="page-view">
        <div style="margin-bottom: 24px">
          <h2 style="font-size: 1.8rem; color: var(--text-main)">
            Continue Reading
          </h2>
          <p style="color: var(--text-muted)">
            Jump back in right where you left off.
          </p>
        </div>
        <div class="grid" id="continueGrid"></div>
      </div>

      <div id="page-admin" class="page-view">
        <div style="margin-bottom: 24px">
          <h2 style="font-size: 1.8rem; color: var(--text-main)">
            Admin Dashboard
          </h2>
          <p style="color: var(--text-muted)">
            Manage the public book catalogue.
          </p>
        </div>
        <div
          id="adminFormContainer"
          style="max-width: 600px; margin: 0 auto"
        ></div>
      </div>
    </div>

    <div class="mobile-nav">
      <button
        class="mobile-link active"
        data-hash="home"
        onclick="window.location.hash='#home'"
      >
        <i class="ph-bold ph-compass"></i> Discover
      </button>
      <button
        class="mobile-link"
        data-hash="library"
        onclick="window.location.hash='#library'"
      >
        <i class="ph-bold ph-books"></i> Library
      </button>
      <button
        class="mobile-link"
        data-hash="continue"
        onclick="window.location.hash='#continue'"
      >
        <i class="ph-bold ph-clock-counter-clockwise"></i> Continue
      </button>
      <button class="mobile-link" onclick="window.app.handleAuthClick()">
        <i class="ph-bold ph-user-circle"></i> Account
      </button>
    </div>

    <div class="modal-backdrop" id="authModal">
      <div class="modal">
        <button
          class="close-modal"
          onclick="window.app.closeModal('authModal')"
        >
          <i class="ph-bold ph-x"></i>
        </button>
        <h3 class="modal-title">Welcome Back</h3>
        <p class="modal-desc">Sign in to sync your library across devices.</p>

        <button
          class="btn-primary"
          style="
            width: 100%;
            justify-content: center;
            background: #fff;
            color: #333;
            border: 1px solid var(--border);
            margin-bottom: 20px;
          "
          onclick="window.api.loginGoogle().then(() => window.app.closeModal('authModal'))"
        >
          <img
            src="https://www.svgrepo.com/show/475656/google-color.svg"
            style="width: 18px"
          />
          Continue with Google
        </button>

        <div
          style="
            text-align: center;
            border-top: 1px solid var(--border);
            padding-top: 15px;
            margin-top: 15px;
            color: var(--text-muted);
            font-size: 0.8rem;
          "
        >
          OR USE EMAIL
        </div>

        <form
          onsubmit="window.app.handleEmailAuth(event)"
          style="margin-top: 15px"
        >
          <div class="form-group">
            <input
              type="email"
              id="emailInput"
              class="input-field"
              placeholder="Email address"
              required
            />
          </div>
          <div class="form-group">
            <input
              type="password"
              id="passInput"
              class="input-field"
              placeholder="Password"
              required
            />
          </div>
          <button
            type="submit"
            class="btn-primary"
            style="width: 100%; justify-content: center"
          >
            Sign In
          </button>
        </form>
      </div>
    </div>

    <div class="reader-overlay" id="readerView">
      <div class="reader-toolbar">
        <button class="icon-btn" onclick="window.app.closeReader()">
          <i class="ph-bold ph-arrow-left"></i>
        </button>
        <span
          style="
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 200px;
          "
          id="readerTitle"
          >Book Title</span
        >
        <div style="display: flex; gap: 10px; align-items: center">
          <button
            class="icon-btn"
            id="readerFavBtn"
            onclick="window.app.toggleReaderFav()"
          >
            <i class="ph-heart"></i>
          </button>
          <input
            type="number"
            id="pageInput"
            class="input-field"
            style="width: 60px; padding: 4px 8px"
            value="1"
            onchange="window.app.updateReaderPage()"
          />
          <button class="btn-primary" onclick="window.app.saveCurrentPage()">
            Save
          </button>
        </div>
      </div>
      <iframe id="pdfFrame" class="reader-frame" src=""></iframe>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        updateDoc,
        arrayUnion,
        arrayRemove,
        collection,
        onSnapshot,
        query,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

      // --- CONFIG ---
      const firebaseConfig = {
        apiKey: "AIzaSyCh6YZVCawcGfyPz6s1K9DJqBeIC-c7Hsw",
        authDomain: "readersparadize-85e8e.firebaseapp.com",
        projectId: "readersparadize-85e8e",
        storageBucket: "readersparadize-85e8e.firebasestorage.app",
        messagingSenderId: "168539796198",
        appId: "1:168539796198:web:d01f9b7915292e6c5fc127",
      };
      const ADMIN_EMAILS = ["tanvirrshuvro@gmail.com"]; // UPDATE THIS

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const googleProvider = new GoogleAuthProvider();
      const APP_ID = "blue-reader-prod";

      // --- API WRAPPER ---
      window.api = {
        loginGoogle: () => signInWithPopup(auth, googleProvider),
        logout: () => signOut(auth),
        loginEmail: (e, p) => signInWithEmailAndPassword(auth, e, p),
        signupEmail: (e, p) => createUserWithEmailAndPassword(auth, e, p),
      };

      // --- STATE ---
      const state = {
        user: null,
        theme: localStorage.getItem("theme") || "light",
        books: [
          {
            id: "b1",
            title: "The Great Gatsby",
            author: "F. Scott Fitzgerald",
            genre: "Classic",
            cover:
              "https://upload.wikimedia.org/wikipedia/commons/7/7a/The_Great_Gatsby_Cover_1925_Retouched.jpg",
            pdfUrl:
              "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
          },
          {
            id: "b2",
            title: "Pride and Prejudice",
            author: "Jane Austen",
            genre: "Romance",
            cover:
              "https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/PrideAndPrejudiceTitlePage.jpg/800px-PrideAndPrejudiceTitlePage.jpg",
            pdfUrl:
              "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
          },
          {
            id: "b3",
            title: "1984",
            author: "George Orwell",
            genre: "Sci-Fi",
            cover:
              "https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1676649712i/1984._SY75_.jpg",
            pdfUrl:
              "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf",
          },
        ],
        progress: {},
        favorites: [],
        filter: "All",
        currentBook: null,
        unsub: null,
      };

      // --- UI CONTROLLER ---
      window.app = {
        init: () => {
          window.app.applyTheme();

          // Listeners
          window.addEventListener("hashchange", window.app.renderPage);
          if (!window.location.hash) window.location.hash = "#home";

          // Auth Listener
          onAuthStateChanged(auth, (user) => {
            if (!user) signInAnonymously(auth);
            state.user = user;

            if (state.unsub) state.unsub(); // Clear old listener

            if (user && !user.isAnonymous) {
              // Subscribe to User Data
              const q = collection(
                db,
                "artifacts",
                APP_ID,
                "users",
                user.uid,
                "progress"
              );
              state.unsub = onSnapshot(q, (snap) => {
                snap.docs.forEach((d) => (state.progress[d.id] = d.data()));
                // Fetch Favs separately for simplicity in this demo
                getDoc(
                  doc(
                    db,
                    "artifacts",
                    APP_ID,
                    "users",
                    user.uid,
                    "prefs",
                    "favs"
                  )
                ).then((s) => {
                  state.favorites = s.exists() ? s.data().ids : [];
                  window.app.renderPage(); // Re-render current view
                });
              });
              document.getElementById("desktopAuthBtn").innerText = "Sign Out";
            } else {
              state.progress = {};
              state.favorites = [];
              document.getElementById("desktopAuthBtn").innerText = "Sign In";
            }
            window.app.renderPage(); // Initial Render
          });

          // Firestore Books Listener
          onSnapshot(
            collection(db, "artifacts", APP_ID, "public", "books"),
            (snap) => {
              const newBooks = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              // Merge uniqueness
              const ids = new Set(newBooks.map((b) => b.id));
              state.books = [
                ...state.books.filter((b) => !ids.has(b.id)),
                ...newBooks,
              ];
              window.app.renderPage();
            }
          );

          window.app.renderPage();
        },

        renderPage: () => {
          const hash = window.location.hash.substring(1) || "home";
          const user = state.user && !state.user.isAnonymous;

          // Admin Protection
          if (
            hash === "admin" &&
            (!user || !ADMIN_EMAILS.includes(state.user.email))
          ) {
            window.location.hash = "#home";
            return;
          }
          document.getElementById("nav-admin").style.display =
            user && ADMIN_EMAILS.includes(state.user.email) ? "block" : "none";

          // View Toggle
          document
            .querySelectorAll(".page-view")
            .forEach((el) => el.classList.remove("active"));
          const activePage = document.getElementById(`page-${hash}`);
          if (activePage) activePage.classList.add("active");

          // Nav State
          document
            .querySelectorAll(".nav-item")
            .forEach((el) =>
              el.classList.toggle(
                "active",
                el.getAttribute("href") === `#${hash}`
              )
            );
          document
            .querySelectorAll(".mobile-link")
            .forEach((el) =>
              el.classList.toggle("active", el.dataset.hash === hash)
            );

          // Content Rendering
          if (hash === "home") window.app.renderHome();
          else if (hash === "library") window.app.renderLibrary();
          else if (hash === "continue") window.app.renderContinue();
          else if (hash === "admin") window.app.renderAdmin();
        },

        renderHome: () => {
          // Filters
          const genres = ["All", ...new Set(state.books.map((b) => b.genre))];
          document.getElementById("genreTabs").innerHTML = genres
            .map(
              (g) =>
                `<button class="filter-tag ${
                  state.filter === g ? "active" : ""
                }" onclick="window.app.setFilter('${g}')">${g}</button>`
            )
            .join("");

          const books =
            state.filter === "All"
              ? state.books
              : state.books.filter((b) => b.genre === state.filter);
          document.getElementById("publicGrid").innerHTML = books
            .map((b) => window.app.bookCard(b))
            .join("");
        },

        renderLibrary: () => {
          if (!state.user || state.user.isAnonymous) {
            document.getElementById("libraryGrid").innerHTML =
              window.app.emptyState(
                "lock-key",
                "Sign in to access your library"
              );
            return;
          }
          const books = state.books.filter((b) =>
            state.favorites.includes(b.id)
          );
          document.getElementById("libraryGrid").innerHTML = books.length
            ? books.map((b) => window.app.bookCard(b)).join("")
            : window.app.emptyState("books", "No favorites yet");
        },

        renderContinue: () => {
          if (!state.user || state.user.isAnonymous) {
            document.getElementById("continueGrid").innerHTML =
              window.app.emptyState("lock-key", "Sign in to track progress");
            return;
          }
          const books = state.books.filter((b) => state.progress[b.id]);
          document.getElementById("continueGrid").innerHTML = books.length
            ? books.map((b) => window.app.bookCard(b)).join("")
            : window.app.emptyState("clock", "No active readings");
        },

        renderAdmin: () => {
          document.getElementById("adminFormContainer").innerHTML = `
                    <form onsubmit="window.app.addBook(event)" style="background:var(--bg-surface); padding:24px; border-radius:12px; border:1px solid var(--border);">
                        <div class="form-group"><input id="nTitle" class="input-field" placeholder="Title" required></div>
                        <div class="form-group"><input id="nAuthor" class="input-field" placeholder="Author" required></div>
                        <div class="form-group"><input id="nGenre" class="input-field" placeholder="Genre" required></div>
                        <div class="form-group"><input id="nCover" class="input-field" placeholder="Cover URL" required></div>
                        <div class="form-group"><input id="nPdf" class="input-field" placeholder="PDF URL" required></div>
                        <button class="btn-primary" style="width:100%; justify-content:center;">Add Book</button>
                    </form>
                 `;
        },

        bookCard: (b) => {
          const prog = state.progress[b.id];
          const pct = prog
            ? Math.min(100, (prog.page / 200) * 100).toFixed(0)
            : 0;
          return `
                <div class="book-card" onclick="window.app.openReader('${
                  b.id
                }')">
                    <div class="book-cover-wrap"><img src="${
                      b.cover
                    }" class="book-cover" onerror="this.src='https://placehold.co/200x300?text=Book'"></div>
                    ${
                      state.favorites.includes(b.id)
                        ? `<div class="fav-badge"><i class="ph-fill ph-heart"></i></div>`
                        : ""
                    }
                    <div class="book-info">
                        <div class="book-title">${b.title}</div>
                        <div class="book-author">${b.author}</div>
                        ${
                          prog
                            ? `<div class="progress-track"><div class="progress-bar" style="width:${pct}%"></div></div>`
                            : ""
                        }
                    </div>
                </div>`;
        },

        emptyState: (icon, text) => `
                <div class="empty-state" style="grid-column:1/-1;">
                    <i class="ph-${icon} empty-icon"></i>
                    <div class="empty-text">${text}</div>
                </div>`,

        // --- ACTIONS ---
        setFilter: (g) => {
          state.filter = g;
          window.app.renderHome();
        },
        toggleTheme: () => {
          state.theme = state.theme === "light" ? "dark" : "light";
          localStorage.setItem("theme", state.theme);
          window.app.applyTheme();
        },
        applyTheme: () => {
          document.body.className = state.theme === "dark" ? "dark-mode" : "";
          document.getElementById("themeIcon").className =
            state.theme === "dark" ? "ph-fill ph-sun" : "ph-fill ph-moon";
        },
        handleAuthClick: () => {
          if (state.user && !state.user.isAnonymous) window.api.logout();
          else document.getElementById("authModal").classList.add("active");
        },
        closeModal: (id) =>
          document.getElementById(id).classList.remove("active"),
        handleEmailAuth: async (e) => {
          e.preventDefault();
          try {
            await window.api.loginEmail(
              document.getElementById("emailInput").value,
              document.getElementById("passInput").value
            );
            window.app.closeModal("authModal");
          } catch (err) {
            try {
              await window.api.signupEmail(
                document.getElementById("emailInput").value,
                document.getElementById("passInput").value
              );
              window.app.closeModal("authModal");
            } catch (err2) {
              alert(err2.message);
            }
          }
        },
        addBook: async (e) => {
          e.preventDefault();
          const book = {
            title: document.getElementById("nTitle").value,
            author: document.getElementById("nAuthor").value,
            genre: document.getElementById("nGenre").value,
            cover: document.getElementById("nCover").value,
            pdfUrl: document.getElementById("nPdf").value,
          };
          await addDoc(
            collection(db, "artifacts", APP_ID, "public", "books"),
            book
          );
          alert("Book Added");
          e.target.reset();
        },

        // --- READER ---
        openReader: (id) => {
          if (
            window.location.hash !== "#home" &&
            (!state.user || state.user.isAnonymous)
          ) {
            window.app.handleAuthClick();
            return;
          }
          state.currentBook = state.books.find((b) => b.id === id);
          document.getElementById("readerTitle").innerText =
            state.currentBook.title;
          document.getElementById("readerView").style.display = "flex";
          document.getElementById("pageInput").value = state.progress[id]
            ? state.progress[id].page
            : 1;
          window.app.updateReaderPage();
          window.app.updateFavBtn();
        },
        closeReader: () => {
          document.getElementById("readerView").style.display = "none";
          document.getElementById("pdfFrame").src = "";
        },
        updateReaderPage: () => {
          const pg = document.getElementById("pageInput").value;
          const url = state.currentBook.pdfUrl;
          // Basic PDF.js params logic
          document.getElementById("pdfFrame").src = url + `#page=${pg}`;
        },
        saveCurrentPage: async () => {
          if (!state.user || state.user.isAnonymous) {
            alert("Sign in to save");
            return;
          }
          const pg = document.getElementById("pageInput").value;
          await setDoc(
            doc(
              db,
              "artifacts",
              APP_ID,
              "users",
              state.user.uid,
              "progress",
              state.currentBook.id
            ),
            { page: pg, lastRead: new Date().toISOString() },
            { merge: true }
          );
        },
        toggleReaderFav: async () => {
          if (!state.user || state.user.isAnonymous) {
            alert("Sign in to favorite");
            return;
          }
          const ref = doc(
            db,
            "artifacts",
            APP_ID,
            "users",
            state.user.uid,
            "prefs",
            "favs"
          );
          const isFav = state.favorites.includes(state.currentBook.id);
          await setDoc(
            ref,
            {
              ids: isFav
                ? arrayRemove(state.currentBook.id)
                : arrayUnion(state.currentBook.id),
            },
            { merge: true }
          );
          // Optimistic UI
          state.favorites = isFav
            ? state.favorites.filter((id) => id !== state.currentBook.id)
            : [...state.favorites, state.currentBook.id];
          window.app.updateFavBtn();
        },
        updateFavBtn: () => {
          const isFav = state.favorites.includes(state.currentBook.id);
          document.getElementById("readerFavBtn").innerHTML = isFav
            ? '<i class="ph-fill ph-heart" style="color:#ef4444"></i>'
            : '<i class="ph-heart"></i>';
        },
      };

      window.onload = window.app.init;
    </script>
  </body>
</html>
