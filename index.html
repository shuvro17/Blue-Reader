<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlueReader | Cloud Library</title>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- CSS STYLES (Fluid / Glassmorphism) --- */
      :root {
        --primary: #6366f1;
        --secondary: #a855f7;
        --accent: #ec4899;
        --glass-bg: rgba(255, 255, 255, 0.65);
        --glass-border: rgba(255, 255, 255, 0.5);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        --text-main: #0f172a;
        --text-muted: #475569;
        --input-bg: rgba(255, 255, 255, 0.9);
        --input-text: #1e293b;
        --input-border: #cbd5e1;
        --radius-lg: 24px;
        --radius-md: 16px;
      }
      .dark-mode {
        --glass-bg: rgba(15, 23, 42, 0.6);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-main: #f8fafc;
        --text-muted: #cbd5e1;
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        --input-bg: rgba(2, 6, 23, 0.6);
        --input-text: #f1f5f9;
        --input-border: #334155;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Plus Jakarta Sans", sans-serif;
      }
      body {
        background: #f0f2f5;
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
        transition: 0.3s ease;
      }
      .dark-mode body {
        background: #020617;
      }

      /* Fluid BG */
      .background-fluid {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        background: linear-gradient(145deg, #e0e7ff, #f3e8ff);
      }
      .dark-mode .background-fluid {
        background: #020617;
      }
      .blob {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.6;
        animation: float 20s infinite ease-in-out alternate;
      }
      .blob-1 {
        width: 500px;
        height: 500px;
        background: var(--primary);
        top: -10%;
        left: -10%;
      }
      .blob-2 {
        width: 400px;
        height: 400px;
        background: var(--secondary);
        bottom: 10%;
        right: -5%;
        animation-delay: -5s;
      }
      @keyframes float {
        0% {
          transform: translate(0, 0) scale(1);
        }
        100% {
          transform: translate(30px, -50px) scale(1.1);
        }
      }

      /* Navbar */
      .navbar {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 1200px;
        height: 70px;
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-radius: 100px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        z-index: 100;
        box-shadow: var(--glass-shadow);
      }
      .logo {
        font-family: "Outfit", sans-serif;
        font-weight: 800;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-main);
        text-decoration: none;
      }
      .nav-links {
        display: flex;
        gap: 10px;
      }
      .nav-btn {
        padding: 10px 20px;
        border-radius: 100px;
        text-decoration: none;
        color: var(--text-muted);
        font-weight: 600;
        font-size: 0.9rem;
        transition: 0.3s;
        cursor: pointer;
      }
      .nav-btn:hover {
        color: var(--primary);
        background: rgba(255, 255, 255, 0.2);
      }
      .nav-btn.active {
        background: var(--text-main);
        color: #fff !important;
      }
      .nav-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .icon-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-main);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: 0.3s;
      }

      /* Main Layout */
      .main-container {
        max-width: 1200px;
        margin: 120px auto 40px;
        padding: 0 20px;
      }
      .page-view {
        display: none;
        animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .page-view.active {
        display: block;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Components */
      .hero-banner {
        width: 100%;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.3);
        border: 1px solid var(--glass-border);
        padding: 40px;
        margin-bottom: 50px;
        display: flex;
        align-items: center;
        gap: 40px;
        backdrop-filter: blur(10px);
      }
      .dark-mode .hero-banner {
        background: rgba(0, 0, 0, 0.3);
      }
      .hero-content {
        flex: 1;
      }
      .hero-title {
        font-family: "Outfit";
        font-size: 3rem;
        font-weight: 800;
        line-height: 1.1;
        margin-bottom: 15px;
      }
      .hero-img {
        width: 180px;
        height: 270px;
        object-fit: cover;
        border-radius: var(--radius-md);
        transform: rotate(-5deg);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      }

      .filters {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 10px;
      }
      .filter-pill {
        padding: 8px 20px;
        border-radius: 100px;
        border: 1px solid var(--glass-border);
        background: var(--glass-bg);
        color: var(--text-muted);
        cursor: pointer;
        font-weight: 600;
        white-space: nowrap;
        transition: 0.3s;
      }
      .filter-pill.active {
        background: var(--primary);
        color: white;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 30px;
      }
      .book-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        padding: 15px;
        position: relative;
        transition: 0.4s;
        cursor: pointer;
      }
      .book-card:hover {
        transform: translateY(-10px);
        border-color: var(--primary);
      }
      .card-img {
        width: 100%;
        aspect-ratio: 2/3;
        object-fit: cover;
        border-radius: 12px;
        margin-bottom: 15px;
      }
      .card-title {
        font-family: "Outfit";
        font-weight: 700;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .admin-controls {
        position: absolute;
        bottom: 15px;
        right: 15px;
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: 0.3s;
      }
      .book-card:hover .admin-controls {
        opacity: 1;
      }
      .admin-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        font-size: 0.9rem;
      }
      .btn-edit {
        background: var(--primary);
      }
      .btn-delete {
        background: #ef4444;
      }

      /* Forms */
      .glass-input {
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        background: var(--input-bg);
        color: var(--input-text);
        border: 1px solid var(--input-border);
        outline: none;
        margin-bottom: 15px;
      }
      .btn-main {
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        border: none;
        background: var(--text-main);
        color: white;
        font-weight: 700;
        cursor: pointer;
      }
      .file-upload-wrap {
        position: relative;
        margin-bottom: 15px;
        border: 2px dashed var(--glass-border);
        padding: 20px;
        text-align: center;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.3s;
      }
      .file-upload-wrap:hover {
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.1);
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        z-index: 200;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .modal-overlay.active {
        display: flex;
      }
      .glass-modal {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        width: 100%;
        max-width: 420px;
        padding: 30px;
        border-radius: 24px;
        box-shadow: var(--glass-shadow);
        position: relative;
        text-align: center;
        animation: popIn 0.3s ease;
        cursor: default;
      }
      @keyframes popIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Reader */
      .reader-view {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--glass-bg);
        z-index: 300;
        display: none;
        flex-direction: column;
      }
      .reader-top {
        height: 70px;
        padding: 0 30px;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
      }

      /* Mobile */
      .mobile-nav {
        display: none;
      }
      @media (max-width: 768px) {
        .navbar {
          top: auto;
          bottom: 20px;
          padding: 0 20px;
          justify-content: space-around;
          height: 65px;
        }
        .nav-links,
        .nav-actions {
          display: none;
        }
        .mobile-nav {
          display: contents;
        }
        .mobile-icon {
          font-size: 1.5rem;
          color: var(--text-muted);
          cursor: pointer;
        }
        .mobile-icon.active {
          color: var(--primary);
        }
        .main-container {
          margin-top: 40px;
          padding-bottom: 100px;
        }
        .hero-banner {
          flex-direction: column-reverse;
          text-align: center;
          padding: 25px;
        }
      }

      /* Loading Spinner */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--primary);
        animation: spin 1s linear infinite;
        margin: 0 auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="background-fluid">
      <div class="blob blob-1"></div>
      <div class="blob blob-2"></div>
    </div>

    <nav class="navbar">
      <a href="#home" class="logo"
        ><i class="ph-fill ph-flying-saucer"></i> BlueReader</a
      >
      <div class="nav-links">
        <a href="#home" class="nav-btn active">Discover</a>
        <a href="#library" class="nav-btn">Library</a>
        <a href="#continue" class="nav-btn">Continue</a>
        <a href="#admin" class="nav-btn" id="nav-admin" style="display: none"
          >Admin</a
        >
      </div>
      <div class="nav-actions">
        <button class="icon-btn" onclick="app.toggleTheme()">
          <i class="ph-fill ph-moon" id="themeIcon"></i>
        </button>
        <button
          class="nav-btn"
          style="background: var(--primary); color: white"
          id="authBtn"
          onclick="app.handleAuth()"
        >
          Sign In
        </button>
      </div>
      <i
        class="ph-bold ph-compass mobile-icon active"
        onclick="location.hash='#home'"
      ></i>
      <i
        class="ph-bold ph-books mobile-icon"
        onclick="location.hash='#library'"
      ></i>
      <i
        class="ph-bold ph-clock-counter-clockwise mobile-icon"
        onclick="location.hash='#continue'"
      ></i>
      <i
        class="ph-bold ph-user-circle mobile-icon"
        onclick="app.handleAuth()"
      ></i>
    </nav>

    <div class="main-container">
      <div id="page-home" class="page-view active">
        <div class="hero-banner">
          <div class="hero-content">
            <span
              style="
                background: var(--primary);
                color: white;
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 700;
              "
              >NEW ARRIVAL</span
            >
            <h1 class="hero-title">The Great Gatsby</h1>
            <p style="color: var(--text-muted); margin-bottom: 20px">
              Classic literature meets modern design.
            </p>
            <button
              class="nav-btn"
              style="background: var(--text-main); color: white"
              onclick="app.openReader('b1')"
            >
              Read Now
            </button>
          </div>
          <img
            src="https://upload.wikimedia.org/wikipedia/commons/7/7a/The_Great_Gatsby_Cover_1925_Retouched.jpg"
            class="hero-img"
          />
        </div>
        <div class="filters" id="genreFilters"></div>
        <div class="grid" id="publicGrid"></div>
      </div>

      <div id="page-library" class="page-view">
        <h1 style="font-family: 'Outfit'; margin-bottom: 20px">My Library</h1>
        <div class="grid" id="libraryGrid"></div>
      </div>

      <div id="page-continue" class="page-view">
        <h1 style="font-family: 'Outfit'; margin-bottom: 20px">
          Continue Reading
        </h1>
        <div class="grid" id="continueGrid"></div>
      </div>

      <div id="page-admin" class="page-view">
        <div
          style="
            background: var(--glass-bg);
            padding: 40px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            max-width: 600px;
            margin: 0 auto;
          "
        >
          <h2
            id="adminFormTitle"
            style="margin-bottom: 20px; font-family: 'Outfit'"
          >
            Add New Book
          </h2>
          <form onsubmit="app.handleBookSubmit(event)">
            <input type="hidden" id="editBookId" />
            <input
              id="nTitle"
              class="glass-input"
              placeholder="Book Title"
              required
            />
            <input
              id="nAuthor"
              class="glass-input"
              placeholder="Author"
              required
            />
            <input
              id="nGenre"
              class="glass-input"
              placeholder="Genre"
              required
            />
            <input
              id="nCover"
              class="glass-input"
              placeholder="Cover Image URL"
              required
            />

            <div
              style="
                color: var(--text-muted);
                margin-bottom: 10px;
                font-size: 0.9rem;
              "
            >
              Upload PDF to Drive or Paste Link
            </div>

            <label class="file-upload-wrap" for="fileInput">
              <i
                class="ph-cloud-arrow-up"
                style="font-size: 1.5rem; color: var(--primary)"
              ></i>
              <div id="fileNameDisplay">Click to select PDF</div>
              <input
                type="file"
                id="fileInput"
                accept="application/pdf"
                style="display: none"
                onchange="app.handleFileSelect(this)"
              />
            </label>

            <div style="text-align: center; margin-bottom: 10px">OR</div>

            <input
              id="nPdf"
              class="glass-input"
              placeholder="PDF URL (If not uploading file)"
            />

            <div class="spinner" id="uploadSpinner"></div>

            <div style="display: flex; gap: 10px">
              <button type="submit" class="btn-main" id="adminSubmitBtn">
                Publish Book
              </button>
              <button
                type="button"
                class="btn-main"
                style="background: var(--text-muted); width: auto"
                onclick="app.resetAdminForm()"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="reader-view" id="readerView">
      <div class="reader-top">
        <button class="icon-btn" onclick="app.closeReader()">
          <i class="ph-bold ph-arrow-left"></i>
        </button>
        <span style="font-weight: 700" id="readerTitle">Book</span>
        <div style="display: flex; gap: 10px">
          <button class="icon-btn" id="readerFav" onclick="app.toggleFav()">
            <i class="ph-heart"></i>
          </button>
          <input
            type="number"
            id="pageInput"
            class="glass-input"
            style="width: 70px; margin: 0; padding: 8px"
            value="1"
            onchange="app.updatePage()"
          />
          <button
            class="nav-btn"
            style="background: var(--primary); color: white"
            onclick="app.saveProgress()"
          >
            Save
          </button>
        </div>
      </div>
      <iframe id="pdfFrame" style="flex: 1; border: none" src=""></iframe>
    </div>

    <div
      class="modal-overlay"
      id="authModal"
      onclick="app.closeModal('authModal')"
    >
      <div class="glass-modal" onclick="event.stopPropagation()">
        <button
          style="
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
          "
          onclick="app.closeModal('authModal')"
        >
          <i class="ph-x" style="font-size: 1.5rem"></i>
        </button>
        <h2 style="font-family: 'Outfit'; margin-bottom: 10px">Welcome</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px">
          Sign in to read and sync your library.
        </p>
        <button
          class="btn-main"
          style="
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          "
          onclick="api.loginGoogle()"
        >
          <img
            src="https://www.svgrepo.com/show/475656/google-color.svg"
            style="width: 20px"
          />
          Continue with Google
        </button>
        <div
          style="
            border-top: 1px solid var(--glass-border);
            margin: 15px 0;
            position: relative;
          "
        >
          <span
            style="
              background: var(--glass-bg);
              padding: 0 10px;
              position: absolute;
              top: -10px;
              left: 50%;
              transform: translateX(-50%);
              font-size: 0.8rem;
              color: var(--text-muted);
            "
            >OR</span
          >
        </div>
        <form onsubmit="app.emailLogin(event)">
          <input
            id="emailIn"
            class="glass-input"
            placeholder="Email"
            required
          />
          <input
            id="passIn"
            type="password"
            class="glass-input"
            placeholder="Password"
            required
          />
          <button class="btn-main">Sign In</button>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        updateDoc,
        arrayUnion,
        arrayRemove,
        collection,
        onSnapshot,
        addDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

      // --- CONFIG ---
      const ADMIN_EMAILS = ["tanvirrshuvro@gmail.com"]; // REPLACE THIS
      const GAS_WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbxa4MrSt5Mo0lKGBB232fSJ7Li54u3UTYGdoQcoBI3tokIACRURJWPZfeoo4eWTkga6/exec";

      const firebaseConfig = {
        apiKey: "AIzaSyCh6YZVCawcGfyPz6s1K9DJqBeIC-c7Hsw",
        authDomain: "readersparadize-85e8e.firebaseapp.com",
        projectId: "readersparadize-85e8e",
        storageBucket: "readersparadize-85e8e.firebasestorage.app",
        messagingSenderId: "168539796198",
        appId: "1:168539796198:web:d01f9b7915292e6c5fc127",
      };

      const fb = initializeApp(firebaseConfig);
      const auth = getAuth(fb);
      const db = getFirestore(fb);
      const APP_ID = "blue-fluid-v2";

      window.api = {
        loginGoogle: () =>
          signInWithPopup(auth, new GoogleAuthProvider()).then(() =>
            app.closeModal("authModal")
          ),
        loginEmail: (e, p) => signInWithEmailAndPassword(auth, e, p),
        signupEmail: (e, p) => createUserWithEmailAndPassword(auth, e, p),
        logout: () => signOut(auth),
      };

      const state = {
        user: null,
        books: [],
        progress: {},
        favs: [],
        filter: "All",
        currentBook: null,
      };

      const formatLink = (url) => {
        if (!url) return "";
        if (url.includes("drive.google.com")) {
          const match = url.match(/\/d\/(.+?)(\/|$)/);
          if (match)
            return `https://drive.google.com/file/d/${match[1]}/preview`;
        }
        if (url.includes("dropbox.com")) return url.replace("dl=0", "raw=1");
        if (url.includes("1drv.ms") || url.includes("onedrive.live.com"))
          return url.includes("?") ? url + "&embed=1" : url + "?embed=1";
        return url;
      };

      window.app = {
        init: () => {
          window.addEventListener("hashchange", app.router);
          onAuthStateChanged(auth, (u) => {
            state.user = u;
            if (u && !u.isAnonymous) {
              onSnapshot(
                collection(db, "artifacts", APP_ID, "users", u.uid, "progress"),
                (s) => {
                  s.docs.forEach((d) => (state.progress[d.id] = d.data()));
                  app.render();
                }
              );
              getDoc(
                doc(db, "artifacts", APP_ID, "users", u.uid, "prefs", "favs")
              ).then((s) => {
                if (s.exists()) state.favs = s.data().ids;
                app.render();
              });
            } else {
              state.progress = {};
              state.favs = [];
              app.render();
            }
            app.updateUI();
          });
          onSnapshot(collection(db, "artifacts", APP_ID, "books"), (s) => {
            state.books = s.docs.map((d) => ({ id: d.id, ...d.data() }));
            app.render();
          });
          if (!location.hash) location.hash = "#home";
          app.router();
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") app.closeModal("authModal");
          });
        },

        router: () => {
          const hash = location.hash.slice(1) || "home";
          document
            .querySelectorAll(".page-view")
            .forEach((e) => e.classList.remove("active"));
          document.getElementById(`page-${hash}`).classList.add("active");
          document
            .querySelectorAll(".nav-btn")
            .forEach((b) =>
              b.classList.toggle(
                "active",
                b.getAttribute("href") === `#${hash}`
              )
            );
          document
            .querySelectorAll(".mobile-icon")
            .forEach((i) => i.classList.remove("active"));
          if (hash === "home")
            document
              .querySelectorAll(".mobile-icon")[0]
              .classList.add("active");
          if (hash === "library")
            document
              .querySelectorAll(".mobile-icon")[1]
              .classList.add("active");
          if (hash === "continue")
            document
              .querySelectorAll(".mobile-icon")[2]
              .classList.add("active");
          app.render();
        },

        updateUI: () => {
          const u = state.user && !state.user.isAnonymous;
          document.getElementById("authBtn").innerText = u
            ? "Sign Out"
            : "Sign In";
          const isAdmin = u && ADMIN_EMAILS.includes(state.user.email);
          document.getElementById("nav-admin").style.display = isAdmin
            ? "block"
            : "none";
        },

        render: () => {
          const genres = ["All", ...new Set(state.books.map((b) => b.genre))];
          document.getElementById("genreFilters").innerHTML = genres
            .map(
              (g) =>
                `<div class="filter-pill ${
                  state.filter === g ? "active" : ""
                }" onclick="app.setFilter('${g}')">${g}</div>`
            )
            .join("");
          const visible =
            state.filter === "All"
              ? state.books
              : state.books.filter((b) => b.genre === state.filter);
          document.getElementById("publicGrid").innerHTML = visible
            .map((b) => app.card(b))
            .join("");
          const lib = state.books.filter((b) => state.favs.includes(b.id));
          document.getElementById("libraryGrid").innerHTML = lib.length
            ? lib.map((b) => app.card(b)).join("")
            : `<div style="grid-column:1/-1; text-align:center; color:var(--text-muted);">No favorites yet.</div>`;
          const cont = state.books.filter((b) => state.progress[b.id]);
          document.getElementById("continueGrid").innerHTML = cont.length
            ? cont.map((b) => app.card(b)).join("")
            : `<div style="grid-column:1/-1; text-align:center; color:var(--text-muted);">No active reads.</div>`;
        },

        card: (b) => {
          const isFav = state.favs.includes(b.id);
          const u = state.user && !state.user.isAnonymous;
          const isAdmin = u && ADMIN_EMAILS.includes(state.user.email);
          return `
                <div class="book-card" onclick="app.openReader('${b.id}')">
                    <img src="${
                      b.cover
                    }" class="card-img" onerror="this.src='https://placehold.co/200x300?text=Book'">
                    ${
                      isFav
                        ? '<div class="fav-btn-card"><i class="ph-fill ph-heart"></i></div>'
                        : ""
                    }
                    <div class="card-title">${b.title}</div>
                    <div class="card-author">${b.author}</div>
                    ${
                      isAdmin
                        ? `
                    <div class="admin-controls" onclick="event.stopPropagation()">
                        <button class="admin-btn btn-edit" onclick="app.editBook('${b.id}')"><i class="ph-pencil"></i></button>
                        <button class="admin-btn btn-delete" onclick="app.deleteBook('${b.id}')"><i class="ph-trash"></i></button>
                    </div>`
                        : ""
                    }
                </div>`;
        },

        setFilter: (g) => {
          state.filter = g;
          app.render();
        },
        handleAuth: () => {
          if (state.user && !state.user.isAnonymous) api.logout();
          else document.getElementById("authModal").classList.add("active");
        },
        emailLogin: async (e) => {
          e.preventDefault();
          try {
            await api.loginEmail(
              document.getElementById("emailIn").value,
              document.getElementById("passIn").value
            );
            app.closeModal("authModal");
          } catch {
            try {
              await api.signupEmail(
                document.getElementById("emailIn").value,
                document.getElementById("passIn").value
              );
              app.closeModal("authModal");
            } catch (err) {
              alert(err.message);
            }
          }
        },
        closeModal: (id) =>
          document.getElementById(id).classList.remove("active"),

        // --- FILE HANDLING ---
        handleFileSelect: (input) => {
          if (input.files.length > 0) {
            document.getElementById("fileNameDisplay").innerText =
              input.files[0].name;
          }
        },

        uploadToDrive: (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
              const base64 = reader.result.split(",")[1];
              const payload = {
                filename: file.name,
                mimeType: file.type,
                file: base64,
              };

              try {
                const res = await fetch(GAS_WEB_APP_URL, {
                  method: "POST",
                  body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (data.status === "success") resolve(data.url);
                else reject(data.message);
              } catch (e) {
                reject(e);
              }
            };
            reader.onerror = (error) => reject(error);
          });
        },

        handleBookSubmit: async (e) => {
          e.preventDefault();
          if (!state.user || !ADMIN_EMAILS.includes(state.user.email))
            return alert("Unauthorized.");

          const submitBtn = document.getElementById("adminSubmitBtn");
          const spinner = document.getElementById("uploadSpinner");
          const fileInput = document.getElementById("fileInput");

          submitBtn.style.display = "none";
          spinner.style.display = "block";

          let pdfUrl = document.getElementById("nPdf").value;

          try {
            if (fileInput.files.length > 0) {
              pdfUrl = await app.uploadToDrive(fileInput.files[0]);
            }

            if (!pdfUrl)
              throw new Error("Please provide a PDF URL or upload a file.");

            const bookData = {
              title: document.getElementById("nTitle").value,
              author: document.getElementById("nAuthor").value,
              genre: document.getElementById("nGenre").value,
              cover: document.getElementById("nCover").value,
              pdfUrl: formatLink(pdfUrl),
            };

            const editId = document.getElementById("editBookId").value;
            if (editId) {
              await updateDoc(
                doc(db, "artifacts", APP_ID, "books", editId),
                bookData
              );
              alert("Book Updated!");
            } else {
              await addDoc(
                collection(db, "artifacts", APP_ID, "books"),
                bookData
              );
              alert("Book Published!");
            }
            app.resetAdminForm();
            location.hash = "#home";
          } catch (err) {
            alert("Error: " + err.message);
          } finally {
            submitBtn.style.display = "block";
            spinner.style.display = "none";
          }
        },

        editBook: (id) => {
          const book = state.books.find((b) => b.id === id);
          if (!book) return;
          document.getElementById("editBookId").value = id;
          document.getElementById("nTitle").value = book.title;
          document.getElementById("nAuthor").value = book.author;
          document.getElementById("nGenre").value = book.genre;
          document.getElementById("nCover").value = book.cover;
          document.getElementById("nPdf").value = book.pdfUrl;
          document.getElementById("adminFormTitle").innerText = "Edit Book";
          document.getElementById("adminSubmitBtn").innerText = "Update Book";
          location.hash = "#admin";
        },

        deleteBook: async (id) => {
          if (!confirm("Delete this book permanently?")) return;
          try {
            await deleteDoc(doc(db, "artifacts", APP_ID, "books", id));
          } catch (err) {
            alert(err.message);
          }
        },

        resetAdminForm: () => {
          document.querySelector("form").reset();
          document.getElementById("editBookId").value = "";
          document.getElementById("fileNameDisplay").innerText =
            "Click to select PDF";
          document.getElementById("adminFormTitle").innerText = "Add New Book";
          document.getElementById("adminSubmitBtn").innerText = "Publish Book";
        },

        openReader: (id) => {
          if (!state.user || state.user.isAnonymous) return app.handleAuth();

          state.currentBook = state.books.find((b) => b.id === id);
          document.getElementById("readerTitle").innerText =
            state.currentBook.title;
          document.getElementById("readerView").style.display = "flex";
          document.getElementById("pdfFrame").src =
            formatLink(state.currentBook.pdfUrl) +
            (state.progress[id] ? `#page=${state.progress[id].page}` : "");
          app.updateFavBtn();
        },

        closeReader: () => {
          document.getElementById("readerView").style.display = "none";
          document.getElementById("pdfFrame").src = "";
        },
        updatePage: () => {
          const pg = document.getElementById("pageInput").value;
          document.getElementById("pdfFrame").src =
            formatLink(state.currentBook.pdfUrl) + `#page=${pg}`;
        },
        saveProgress: async () => {
          if (!state.user || state.user.isAnonymous)
            return alert("Sign in to save.");
          const pg = document.getElementById("pageInput").value;
          await setDoc(
            doc(
              db,
              "artifacts",
              APP_ID,
              "users",
              state.user.uid,
              "progress",
              state.currentBook.id
            ),
            { page: pg, lastRead: new Date().toISOString() },
            { merge: true }
          );
          alert("Saved!");
        },
        toggleFav: async () => {
          if (!state.user || state.user.isAnonymous) return alert("Sign in.");
          const ref = doc(
            db,
            "artifacts",
            APP_ID,
            "users",
            state.user.uid,
            "prefs",
            "favs"
          );
          const isFav = state.favs.includes(state.currentBook.id);
          await setDoc(
            ref,
            {
              ids: isFav
                ? arrayRemove(state.currentBook.id)
                : arrayUnion(state.currentBook.id),
            },
            { merge: true }
          );
          if (isFav)
            state.favs = state.favs.filter((id) => id !== state.currentBook.id);
          else state.favs.push(state.currentBook.id);
          app.updateFavBtn();
          app.render();
        },
        updateFavBtn: () => {
          const isFav = state.favs.includes(state.currentBook.id);
          document.getElementById("readerFav").innerHTML = isFav
            ? '<i class="ph-fill ph-heart" style="color:#ec4899"></i>'
            : '<i class="ph-heart"></i>';
        },
        toggleTheme: () => {
          document.body.classList.toggle("dark-mode");
          document.getElementById("themeIcon").className =
            document.body.classList.contains("dark-mode")
              ? "ph-fill ph-sun"
              : "ph-fill ph-moon";
        },
      };

      window.onload = app.init;
    </script>
  </body>
</html>
