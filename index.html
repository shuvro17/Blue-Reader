<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueReader | Interactive Library</title>
    
    <!-- Phosphor Icons for UI elements -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Firebase SDKs - Mandatory for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION (Ensure these match your Firebase project) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCh6YZVCawcGfyPz6s1K9DJqBeIC-c7Hsw",
            authDomain: "readersparadize-85e8e.firebaseapp.com",
            projectId: "readersparadize-85e8e",
            storageBucket: "readersparadize-85e8e.firebasestorage.app",
            messagingSenderId: "168539796198",
            appId: "1:168539796198:web:d01f9b7915292e6c5fc127",
            measurementId: "G-GZ61PZQXC5"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.auth = auth;
        window.db = db;
        window.appId = appId;
        window.googleProvider = new GoogleAuthProvider();
        
        // Expose Auth functions
        window.loginEmail = async (e, p) => signInWithEmailAndPassword(auth, e, p);
        window.signupEmail = async (e, p) => createUserWithEmailAndPassword(auth, e, p);
        window.loginGoogle = async () => signInWithPopup(auth, window.googleProvider);
        window.logout = async () => signOut(auth);
        
        // Initial Auth Logic: Handle token sign-in or fall back to anonymous if needed
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        // Sign in anonymously if no user is present
                        signInAnonymously(auth).catch(err => console.error("Anon Auth Failed:", err));
                    }
                });
            }
        };
        initAuth();

        // Firestore Helpers
        window.saveBookProgress = async (bookId, page) => {
            const user = auth.currentUser;
            if(!user || user.isAnonymous) return;
            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', bookId);
            await setDoc(ref, { page: page, lastRead: new Date().toISOString(), bookId: bookId }, { merge: true });
        };

        window.toggleFav = async (bookId) => {
             const user = auth.currentUser;
            if(!user || user.isAnonymous) return;
            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'preferences', 'favorites');
            const docSnap = await getDoc(ref);
            
            let isFav = false;
            if(docSnap.exists() && docSnap.data().ids.includes(bookId)) {
                await updateDoc(ref, { ids: arrayRemove(bookId) });
                isFav = false;
            } else {
                await setDoc(ref, { ids: arrayUnion(bookId) }, { merge: true });
                isFav = true;
            }
            // Re-fetch user data to update appState immediately
            await fetchUserData(user); 
            return isFav; 
        };

        window.addBookToDB = async (bookData) => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'books');
            await addDoc(colRef, bookData);
        };

        // Real-time listener for public book data
        window.subscribeToBooks = (callback) => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'books');
            return onSnapshot(colRef, (snapshot) => {
                const books = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                callback(books);
            }, (error) => console.error("Error fetching books:", error));
        };
        
        // Function to fetch all user data (progress and favorites)
        window.fetchUserData = async (user) => {
            if (!user || user.isAnonymous) {
                appState.progress = {};
                appState.favorites = [];
                render();
                return;
            }

            // Fetch Progress
            const progressRef = collection(db, 'artifacts', appId, 'users', user.uid, 'progress');
            onSnapshot(progressRef, (snapshot) => {
                const progress = {};
                snapshot.docs.forEach(doc => {
                    progress[doc.id] = doc.data();
                });
                appState.progress = progress;
                render();
            }, (error) => console.error("Error fetching progress:", error));

            // Fetch Favorites
            const favRef = doc(db, 'artifacts', appId, 'users', user.uid, 'preferences', 'favorites');
            onSnapshot(favRef, (docSnap) => {
                appState.favorites = docSnap.exists() ? docSnap.data().ids || [] : [];
                render();
            }, (error) => console.error("Error fetching favorites:", error));
        };
    </script>

    <style>
        /* Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        /* CSS Variables */
        :root {
            --primary-color: #0d6efd;
            --primary-color-light: #3b8aff;
            --text-light: #f0f0f0;
            --text-dark: #333;
            --sidebar-bg-light: rgba(255, 255, 255, 0.2); /* Highly transparent white */
            --content-bg-light: rgba(255, 255, 255, 0.95);
            --border-color-light: rgba(13, 110, 253, 0.3); /* Subtle blue border */
            --bg-dark: #050505; 
            --text-dark-theme: #e0e0e0;
            --sidebar-bg-dark: rgba(30, 30, 30, 0.4); /* Highly transparent dark */
            --content-bg-dark: rgba(42, 42, 42, 0.95);
            --border-color-dark: #444;
            --box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25); 
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); 
        }

        /* Base Styles - Full-Screen, Borderless Look */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { 
            background-color: #f0f2f5; 
            color: var(--text-dark); 
            min-height: 100vh; 
            padding: 0;
            margin: 0;
            display: flex; /* Ensure container fills viewport */
            transition: background-color 0.3s, color 0.3s; 
            overflow-x: hidden; 
        }
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; }

        /* Main Container - App Shell (Now full-screen and fluid) */
        .portfolio-container { 
            width: 100%; 
            height: 100vh;
            display: flex; 
            overflow: hidden; 
            /* Remove fixed radius and strong background/shadow */
            background: transparent;
            box-shadow: none;
            border-radius: 0;
        }

        /* Sidebar - Floating Glassmorphism Panel */
        .sidebar { 
            width: 300px; 
            padding: 30px 20px; 
            text-align: center; 
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            
            /* Glassmorphism effect */
            background: var(--sidebar-bg-light);
            backdrop-filter: blur(15px);
            border-right: 1px solid var(--border-color-light); 
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            z-index: 100;
        }
        .sidebar-content { position: static; width: 100%; }
        .profile-photo { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-color); object-fit: cover; margin-bottom: 15px; margin-left: auto; margin-right: auto; display: block; background: #ddd; }
        .name { font-size: 1.3rem; font-weight: 600; margin-bottom: 5px; }
        .title { font-size: 0.8rem; font-weight: 400; color: var(--text-dark); background: var(--border-color-light); display: inline-block; padding: 4px 10px; border-radius: 12px; margin-bottom: 15px; }
        .separator { border: 0; height: 1px; background: var(--border-color-light); margin: 15px 0; }
        
        .nav-menu { list-style: none; text-align: left; margin-top: 15px; }
        .nav-menu li { margin-bottom: 10px; }
        .nav-btn { 
            width: 100%; 
            text-align: left; 
            padding: 10px 15px; 
            background: transparent; 
            border: none; 
            border-radius: 8px; 
            color: var(--text-dark); /* Use dark color for better contrast on light glass */
            font-weight: 500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1rem; 
        }
        .nav-btn:hover {
            background: rgba(13, 110, 253, 0.1); /* Subtle hover effect */
            transform: scale(1.02);
        }
        .nav-btn.active { 
            background: var(--primary-color); 
            color: white; 
            transform: translateX(0);
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.4); 
        }
        .nav-btn i { font-size: 1.2rem; }

        /* Main Content - Fluid Dashboard */
        .main-content { 
            flex-grow: 1; 
            padding: 50px 40px; 
            position: relative; 
            overflow-y: auto; 
            height: 100vh; /* Match viewport height */
            background: rgba(255, 255, 255, 0.05); /* Very light, transparent overlay */
        }
        
        /* Tabs & Filters */
        .tabs ul { list-style: none; display: flex; gap: 15px; border-bottom: 1px solid var(--border-color-light); margin-bottom: 30px; flex-wrap: wrap;}
        .tab-link { 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: #888; 
            padding: 10px 5px; 
            display: block; 
            font-weight: 500; 
            position: relative; 
            border-bottom: 3px solid transparent; 
            transition: color 0.3s, border-color 0.3s; 
            font-size: 1rem; 
        }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        
        .section-title { font-size: 2rem; margin-bottom: 5px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .section-subtitle { font-size: 1.1rem; color: #666; margin-bottom: 30px; font-weight: 300; }

        /* Book Grid - Responsive Fix */
        .portfolio-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 30px; /* Increased spacing for fluid look */
            margin-bottom: 40px;
        }

        /* Book Card - Bookish Aesthetic with 3D Hover */
        .project-card { 
            background: var(--content-bg-light); 
            border-radius: 12px; 
            padding: 15px; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; 
            cursor: pointer; 
            border: 1px solid rgba(255,255,255,0.8); /* Lighter border for light mode */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* Sleek shadow */
            transform-style: preserve-3d;
            transform: perspective(1000px);
        }
        .project-card:hover { 
            transform: translateY(-10px) rotateX(1deg) perspective(1000px); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.25); 
        }
        .book-cover { 
            width: 100%; 
            aspect-ratio: 2/3; 
            border-radius: 8px; 
            object-fit: cover; 
            margin-bottom: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
        }
        .project-card h5 { font-size: 1rem; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .project-card p { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        
        /* Progress Bar */
        .progress-bar { height: 4px; background: var(--border-color-light); border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.5s; }

        /* Buttons and Modals - Retained styles for function/look */
        .btn-primary { 
            padding: 12px 25px; 
            background: var(--primary-color); 
            color: #fff; 
            border: none; 
            border-radius: 25px; 
            font-size: 0.9rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            text-decoration: none; 
        }
        .btn-primary:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3); }
        .btn-primary:active { transform: translateY(0); box-shadow: none; }
        
        .toggle-btn { 
            position: fixed; /* Fixed position outside main container */
            top: 30px; 
            right: 40px; 
            background: var(--sidebar-bg-light); 
            color: var(--text-dark); 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border: 1px solid var(--border-color-light); 
            cursor: pointer; 
            font-size: 1.2rem; 
            z-index: 200; /* Higher Z-index to float over sidebar */
            transition: all 0.3s; 
            backdrop-filter: blur(5px);
        }

        /* Dark Mode adjustments for new look */
        body.dark-mode { background-color: var(--bg-dark); color: var(--text-dark-theme); }
        .dark-mode .sidebar { 
            background: var(--sidebar-bg-dark);
            border-right-color: var(--border-color-dark);
            box-shadow: 2px 0 10px rgba(255, 255, 255, 0.05);
        }
        .dark-mode .main-content {
            background: rgba(0, 0, 0, 0.15); /* More visible overlay in dark mode */
        }
        .dark-mode .title { background: var(--content-bg-dark); color: var(--text-dark-theme); }
        .dark-mode .nav-btn { color: var(--text-dark-theme); }
        .dark-mode .separator, .dark-mode .tabs ul { border-color: var(--border-color-dark); }
        .dark-mode .toggle-btn { background: var(--sidebar-bg-dark); color: var(--text-dark-theme); border-color: var(--border-color-dark); }
        .dark-mode .project-card { 
            background: rgba(30, 30, 30, 0.8);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .dark-mode .project-card:hover { 
            box-shadow: 0 25px 50px rgba(0,0,0,0.7);
        }
        .dark-mode .section-subtitle { color: #aaa; }
        .dark-mode .form-input { background: var(--sidebar-bg-dark); border-color: var(--border-color-dark); color: white; }
        .dark-mode .modal-box { background: rgba(30, 30, 30, 0.95); }


        /* Responsive Styles (Mobile-First Dashboard) */
        @media (max-width: 900px) {
            body { padding: 0; }
            .portfolio-container { 
                flex-direction: column; 
                height: 100vh;
            }
            .toggle-btn { top: 15px; right: 15px; z-index: 2000; }
            
            /* Sidebar becomes fixed header/nav */
            .sidebar { 
                width: 100%; 
                height: auto;
                position: fixed; 
                bottom: 0;
                top: auto;
                padding: 10px 0;
                border: none;
                border-top: 1px solid var(--border-color-light);
                z-index: 1000;
                background: var(--sidebar-bg-light);
            }
            .dark-mode .sidebar { border-top: 1px solid var(--border-color-dark); }

            .sidebar-content { 
                display: flex; 
                flex-direction: column;
            }
            .sidebar .auth-info { display: none; } /* Hide user info block on mobile */
            
            /* Horizontal scrolling nav bar */
            .nav-menu { 
                display: flex; 
                overflow-x: auto; 
                gap: 10px; 
                padding: 0 10px;
                white-space: nowrap; 
                margin: 0;
            }
            .nav-menu li { margin: 0; flex-shrink: 0; }
            .nav-btn { 
                padding: 8px 12px; 
                font-size: 0.8rem; 
                justify-content: center; 
                background: rgba(0,0,0,0.05); /* Mobile background */
                color: #666;
            }
            .dark-mode .nav-btn { background: rgba(255,255,255,0.05); color: #aaa; }
            .nav-btn i { display: none; }
            .nav-btn.active { color: white; background: var(--primary-color); }
            
            /* Main Content takes over full screen above the fixed nav */
            .main-content { 
                padding: 20px 15px 70px 15px; /* Add bottom padding to clear the fixed nav bar */
                overflow-y: auto; 
                height: 100%;
            }
            .section-title { font-size: 1.6rem; }
            .section-subtitle { margin-bottom: 15px; font-size: 0.9rem; }
            .portfolio-grid { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 15px;
            }
            .project-card { padding: 10px; }
            .project-card h5 { font-size: 0.9rem; }
            .project-card p { font-size: 0.75rem; }
            
            /* Branding adjustment */
            .sidebar .branding {
                display: none; /* Hide branding on mobile to save space, relies on toggle-btn */
            }
            .sidebar #authBtn { display: none; } /* Handle auth via mobile header or dedicated modal */
        }
    </style>
</head>
<body>
    <!-- Sound -->
    <audio id="clickSound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="></audio> 

    <!-- Particles Background -->
    <canvas id="particles-js"></canvas>

    <!-- Loading -->
    <div id="loadingScreen">
        L<span class="loading-o"></span>ADING
    </div>

    <!-- Theme Toggle -->
    <button class="toggle-btn" onclick="toggleTheme()">
        <i class="ph-fill ph-moon" id="themeIcon"></i>
    </button>

    <div class="portfolio-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- Branding / Logo -->
                <div class="branding" style="margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="ph-fill ph-book-open-text" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <h2 style="font-size: 1.8rem; font-weight: 700; margin: 0;">Blue<span style="color: var(--primary-color);">Reader</span></h2>
                </div>

                <div class="auth-info">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Guest" id="userAvatar" class="profile-photo" alt="Profile">
                    <h1 class="name" id="userName">Guest Reader</h1>
                    <span class="title" id="userStatus">Log in to sync</span>
                    <div class="separator"></div>
                </div>

                <ul class="nav-menu">
                    <li><button id="nav-home" class="nav-btn active" onclick="switchTab('home', this)"><i class="ph-bold ph-house"></i> Discover</button></li>
                    <li><button id="nav-library" class="nav-btn" onclick="switchTab('library', this)"><i class="ph-bold ph-books"></i> My Library</button></li>
                    <li><button id="nav-continue" class="nav-btn" onclick="switchTab('continue', this)"><i class="ph-bold ph-clock-counter-clockwise"></i> Continue</button></li>
                    <li id="adminBtn" style="display: none;"><button class="nav-btn" onclick="openAdmin()"><i class="ph-bold ph-plus-circle"></i> Add Book</button></li>
                </ul>

                <div class="separator"></div>

                <button id="authBtn" class="btn-primary" style="width: 100%; justify-content: center; margin-top: 10px;" onclick="handleAuthClick()">
                    Sign In
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- View: Home -->
            <div id="view-home" class="tab-content" style="display: block;">
                <div class="section-title">
                    <h2>Discover New Worlds</h2>
                </div>
                <p class="section-subtitle">Explore our curated collection of free e-books by genre.</p>
                
                <div class="tabs">
                    <ul id="genreTabs">
                        <li><button class="tab-link active" onclick="filterBooks('All', this)">All</button></li>
                        <!-- Genres injected via JS -->
                    </ul>
                </div>

                <div class="portfolio-grid" id="publicGrid">
                    <!-- Books injected here -->
                </div>
            </div>

            <!-- View: Library (Favs and Started) -->
            <div id="view-library" class="tab-content" style="display: none;">
                <div class="section-title">
                    <h2>My Library</h2>
                </div>
                <p class="section-subtitle">Your personal collection of favorited and in-progress books.</p>
                <div class="portfolio-grid" id="libraryGrid">
                    <div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">
                        Log in and start reading to build your library.
                    </div>
                </div>
            </div>

             <!-- View: Continue -->
             <div id="view-continue" class="tab-content" style="display: none;">
                <div class="section-title">
                    <h2>Continue Reading</h2>
                </div>
                <p class="section-subtitle">Pick up exactly where you left off on your latest reads.</p>
                <div class="portfolio-grid" id="continueGrid">
                    <p style="color:#888; grid-column: 1/-1; text-align:center;">Start reading a book to see it here.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal" onclick="closeModal('authModal')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button onclick="closeModal('authModal')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #888;"><i class="ph-bold ph-x"></i></button>
            <h2 class="section-title" style="justify-content: center;">Welcome to BlueReader</h2>
            <p style="text-align: center; color: #888; margin-bottom: 20px;">Sign in to save your progress across devices.</p>
            
            <button class="btn-primary" onclick="handleGoogleLogin()" style="width: 100%; justify-content: center; background: white; color: #333; border: 1px solid #ddd; margin-bottom: 20px;">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" style="width: 20px; margin-right: 10px;"> Continue with Google
            </button>

            <div style="text-align: center; color: #aaa; margin-bottom: 15px; font-size: 0.8rem;">OR EMAIL</div>

            <form onsubmit="handleEmailAuth(event)">
                <div class="form-group">
                    <input type="email" id="emailInput" class="form-input" placeholder="Email Address" required>
                </div>
                <div class="form-group">
                    <input type="password" id="passInput" class="form-input" placeholder="Password (Min 6 characters)" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; justify-content: center;">Sign In / Sign Up</button>
            </form>
        </div>
    </div>

    <!-- Admin Modal -->
    <div class="modal-overlay" id="adminModal" onclick="closeModal('adminModal')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button onclick="closeModal('adminModal')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #888;"><i class="ph-bold ph-x"></i></button>
            <h2 class="section-title">Add New Book</h2>
            <form onsubmit="submitNewBook(event)">
                <div class="form-group"><input type="text" id="nbTitle" class="form-input" placeholder="Title" required></div>
                <div class="form-group"><input type="text" id="nbAuthor" class="form-input" placeholder="Author" required></div>
                <div class="form-group"><input type="text" id="nbGenre" class="form-input" placeholder="Genre (e.g., Classic, Romance, Sci-Fi)" required></div>
                <div class="form-group"><input type="url" id="nbCover" class="form-input" placeholder="Cover Image URL (e.g., from Wikipedia or Imgur)" required></div>
                <div class="form-group"><input type="url" id="nbPdf" class="form-input" placeholder="PDF Link (Google Drive / OneDrive / Direct URL)" required></div>
                <button type="submit" class="btn-primary" style="width: 100%; justify-content: center;">Add to Library</button>
            </form>
        </div>
    </div>

    <!-- PDF Reader -->
    <div id="readerModal">
        <div class="reader-header">
            <button onclick="closeReader()" style="background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; gap: 5px;"><i class="ph-bold ph-arrow-left"></i> Back</button>
            <span id="readerTitle" style="font-weight: 600;">Book Title</span>
            <button id="readerFavBtn" onclick="toggleReaderFav()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; transition: transform 0.1s;" onmousedown="this.style.transform='scale(0.9)'" onmouseup="this.style.transform='scale(1)'"><i class="ph-heart"></i></button>
        </div>
        <div class="reader-body">
            <iframe id="pdfFrame" style="width: 100%; height: 100%; border: none;" src=""></iframe>
            <div class="reader-controls">
                <span>Page</span>
                <input type="number" id="pageInput" style="width: 60px; background: #333; border: none; color: white; text-align: center; border-radius: 5px; padding: 5px;" value="1">
                <button onclick="saveCurrentPage()" class="btn-primary" style="background: var(--primary-color); padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; height: 30px;">SAVE</button>
            </div>
        </div>
    </div>

    <!-- Advanced Constellation Particles Script -->
    <script>
        const canvas = document.getElementById('particles-js');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let particles = [];
        let mouse = { x: null, y: null, radius: 150 };

        function initCanvas() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            
            // Create particles (Responsive density)
            particles = [];
            const numParticles = Math.floor((width * height) / 9000); 
            for (let i = 0; i < numParticles; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 0.8, // Slightly slower movement
                    vy: (Math.random() - 0.5) * 0.8,
                    size: Math.random() * 2 + 1
                });
            }
        }

        window.addEventListener('resize', initCanvas);
        window.addEventListener('mousemove', (e) => {
            mouse.x = e.x;
            mouse.y = e.y;
        });
        window.addEventListener('mouseout', () => {
            mouse.x = null;
            mouse.y = null;
        });

        function animateParticles() {
            ctx.clearRect(0, 0, width, height);
            
            const isDark = document.body.classList.contains('dark-mode');
            const dotColor = isDark ? 'rgba(255, 255, 255, 0.4)' : 'rgba(13, 110, 253, 0.5)';
            const lineColor = isDark ? '255, 255, 255' : '13, 110, 253'; 

            // Update & Draw Particles
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;

                // Bounce off edges
                if (p.x < 0 || p.x > width) p.vx *= -1;
                if (p.y < 0 || p.y > height) p.vy *= -1;

                // Draw Dot
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = dotColor;
                ctx.fill();
            });

            // Draw Connections
            for (let a = 0; a < particles.length; a++) {
                // Connection distance check (optimized loop)
                for (let b = a + 1; b < particles.length; b++) { 
                    let dx = particles[a].x - particles[b].x;
                    let dy = particles[a].y - particles[b].y;
                    let distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 120) {
                        ctx.beginPath();
                        ctx.strokeStyle = `rgba(${lineColor}, ${0.8 - distance / 120})`;
                        ctx.lineWidth = 1;
                        ctx.moveTo(particles[a].x, particles[a].y);
                        ctx.lineTo(particles[b].x, particles[b].y);
                        ctx.stroke();
                    }
                }
                
                // Connect to mouse
                if(mouse.x) {
                    let dx = particles[a].x - mouse.x;
                    let dy = particles[a].y - mouse.y;
                    let distance = Math.sqrt(dx*dx + dy*dy);
                    if(distance < mouse.radius) {
                         ctx.beginPath();
                        ctx.strokeStyle = `rgba(${lineColor}, ${1 - distance / mouse.radius})`;
                        ctx.lineWidth = 1;
                        ctx.moveTo(particles[a].x, particles[a].y);
                        ctx.lineTo(mouse.x, mouse.y);
                        ctx.stroke();
                    }
                }
            }

            requestAnimationFrame(animateParticles);
        }

        initCanvas();
        animateParticles();
    </script>

    <script>
        // --- APP LOGIC ---
        
        // !!! IMPORTANT !!!
        // REPLACE "your-email@gmail.com" WITH YOUR ACTUAL GOOGLE EMAIL BELOW
        const adminEmails = ["your-email@gmail.com"]; 

        function playSound() {
            // This is a short, high-frequency sound for a 'click' feel
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = 'sine'; o.frequency.setValueAtTime(800, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
                g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime + 0.05);
            } catch (e) {
                console.warn("Audio context failed:", e);
            }
        }

        const staticBooks = [
            { id: 'b1', title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', genre: 'Classic', cover: 'https://upload.wikimedia.org/wikipedia/commons/7/7a/The_Great_Gatsby_Cover_1925_Retouched.jpg', pdfUrl: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf' },
            { id: 'b2', title: 'Pride and Prejudice', author: 'Jane Austen', genre: 'Romance', cover: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/PrideAndPrejudiceTitlePage.jpg/800px-PrideAndPrejudiceTitlePage.jpg', pdfUrl: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf' },
            { id: 'b3', title: '1984', author: 'George Orwell', genre: 'Dystopian', cover: 'https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1676649712i/1984._SY75_.jpg', pdfUrl: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf' },
            { id: 'b4', title: 'Moby Dick', author: 'Herman Melville', genre: 'Adventure', cover: 'https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1327940562i/153747.jpg', pdfUrl: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf' },
        ];

        let appState = {
            user: null,
            theme: 'light',
            progress: {},
            favorites: [],
            currentBook: null,
            books: [...staticBooks],
            filter: 'All'
        };

        // Init
        window.onload = () => {
            setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 1500);
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
                appState.theme = 'dark';
                document.getElementById('themeIcon').className = 'ph-fill ph-sun';
            }
        };

        // Book Listener: Merges static books with dynamic Firestore books
        const bookInterval = setInterval(() => {
            if (window.subscribeToBooks) {
                clearInterval(bookInterval);
                window.subscribeToBooks((firestoreBooks) => {
                    // Combine static books with Firestore books, removing duplicates by ID
                    const firestoreBookMap = new Map(firestoreBooks.map(b => [b.id, b]));
                    const uniqueStaticBooks = staticBooks.filter(b => !firestoreBookMap.has(b.id));
                    appState.books = [...uniqueStaticBooks, ...firestoreBooks];
                    render();
                });
            }
        }, 500);

        // Auth Listener: Handles user state changes
        const authInterval = setInterval(() => {
            if (window.auth) {
                clearInterval(authInterval);
                window.auth.onAuthStateChanged(async (user) => {
                    appState.user = user;
                    
                    if (user && !user.isAnonymous) {
                        // Logged in user: Fetch private data
                        console.log("Logged in as:", user.email.toLowerCase()); 
                        
                        document.getElementById('userAvatar').src = user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`;
                        document.getElementById('userName').innerText = user.displayName || user.email.split('@')[0];
                        document.getElementById('userStatus').innerText = "Premium Reader";
                        document.getElementById('authBtn').innerHTML = '<i class="ph-bold ph-sign-out"></i> Sign Out';
                        
                        // Fetch user specific data
                        await window.fetchUserData(user); 

                        // Auto-switch to Library Dashboard
                        if(document.getElementById('view-home').style.display === 'block') {
                            switchTab('library', document.getElementById('nav-library'));
                        }
                    } else {
                        // Guest/Anonymous user
                        document.getElementById('userAvatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=Guest`;
                        document.getElementById('userName').innerText = "Guest Reader";
                        document.getElementById('userStatus').innerText = "Log in to sync";
                        document.getElementById('authBtn').innerHTML = '<i class="ph-bold ph-sign-in"></i> Sign In';
                        // Clear private data
                        appState.progress = {};
                        appState.favorites = [];
                        render(); 
                    }
                });
            }
        }, 100);

        // UI Functions
        function toggleTheme() {
            playSound();
            document.body.classList.toggle('dark-mode');
            appState.theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', appState.theme);
            document.getElementById('themeIcon').className = appState.theme === 'dark' ? 'ph-fill ph-sun' : 'ph-fill ph-moon';
        }

        function switchTab(tabName, btn) {
            playSound();
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected
            document.getElementById('view-'+tabName).style.display = 'block';
            if (btn) btn.classList.add('active'); // Check if button is passed (e.g., from initial login)
            
            // Re-render to ensure current tab data is fresh
            render(); 
        }

        function filterBooks(genre, btn) {
            playSound();
            appState.filter = genre;
            document.querySelectorAll('#genreTabs .tab-link').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function render() {
            // Admin Logic
            const isAdmin = appState.user && !appState.user.isAnonymous && 
                            adminEmails.some(email => email.toLowerCase() === appState.user.email.toLowerCase());
            document.getElementById('adminBtn').style.display = isAdmin ? 'list-item' : 'none';

            // --- Home Tab (Public Grid) ---
            const genres = ['All', ...new Set(appState.books.map(b => b.genre))];
            document.getElementById('genreTabs').innerHTML = genres.map(g => `
                <li><button class="tab-link ${appState.filter === g ? 'active' : ''}" onclick="filterBooks('${g}', this)">${g}</button></li>
            `).join('');

            const publicFiltered = appState.filter === 'All' ? appState.books : appState.books.filter(b => b.genre === appState.filter);
            document.getElementById('publicGrid').innerHTML = publicFiltered.map(b => getBookCard(b, true)).join('');

            // --- Library Tab (Favorites + Started) ---
            if(appState.user && !appState.user.isAnonymous) {
                // Filter books that are either favorited OR have progress
                const libraryBooks = appState.books.filter(b => 
                    appState.favorites.includes(b.id) || appState.progress[b.id]
                );
                
                if(libraryBooks.length > 0) {
                     document.getElementById('libraryGrid').innerHTML = libraryBooks.map(b => getBookCard(b, false)).join('');
                } else {
                     document.getElementById('libraryGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">Your library is empty. Go to the Discover tab and start reading or add favorites!</div>';
                }
            } else {
                document.getElementById('libraryGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">Log in to build your personal library.</div>';
            }

            // --- Continue Reading Tab ---
            const continueReading = appState.books
                .filter(b => appState.progress[b.id])
                .sort((a, b) => new Date(appState.progress[b.id].lastRead) - new Date(appState.progress[a.id].lastRead)); // Sort by most recent read

            if(continueReading.length > 0) {
                document.getElementById('continueGrid').innerHTML = continueReading.map(b => getBookCard(b, false)).join('');
            } else {
                document.getElementById('continueGrid').innerHTML = '<p style="color:#888; grid-column: 1/-1; text-align:center;">You haven\'t started any books yet. Get reading!</p>';
            }
        }

        function getBookCard(book, requireAuth) {
            const progress = appState.progress[book.id];
            // Mock total pages for progress bar demo (assuming 200 pages max)
            const progressPercent = progress ? Math.min(100, (progress.page / 200) * 100).toFixed(0) : 0; 
            const isFav = appState.favorites.includes(book.id);
            const overlayClass = requireAuth && (!appState.user || appState.user.isAnonymous) ? 'auth-overlay' : '';
            
            return `
                <div class="project-card" onclick="openBook('${book.id}', ${requireAuth})">
                    <img src="${book.cover}" class="book-cover" onerror="this.src='https://placehold.co/200x300/CCCCCC/333333?text=${book.title.substring(0, 1).toUpperCase()}'">
                    <h5>${book.title}</h5>
                    <p>${book.author}</p>
                    ${progress ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <p style="font-size: 0.75rem; margin-top: 5px; color: var(--primary-color);">${progressPercent}% Complete (Pg ${progress.page})</p>
                    ` : ''}
                    ${isFav && !requireAuth ? '<i class="ph-fill ph-heart" style="position:absolute; top: 10px; right: 10px; color: red;"></i>' : ''}
                </div>
            `;
        }

        // Modal Functions
        function closeModal(id) { 
            playSound();
            document.getElementById(id).classList.remove('active'); 
        }
        function openAdmin() { 
            playSound();
            document.getElementById('adminModal').classList.add('active'); 
        }
        
        function handleAuthClick() {
            playSound();
            if(appState.user && !appState.user.isAnonymous) {
                window.logout();
            } else {
                document.getElementById('authModal').classList.add('active');
            }
        }

        async function handleGoogleLogin() {
            playSound();
            try { 
                await window.loginGoogle(); 
                closeModal('authModal'); 
            } catch(e) { 
                console.error("Google Login Failed:", e);
                alert("Google Login failed. Error: " + (e.message || "Check console for details.")); 
            }
        }

        async function handleEmailAuth(e) {
            e.preventDefault();
            playSound();
            const em = document.getElementById('emailInput').value;
            const pw = document.getElementById('passInput').value;
            
            if (pw.length < 6) {
                alert("Password must be at least 6 characters long.");
                return;
            }

            try { 
                await window.loginEmail(em, pw); 
                closeModal('authModal'); 
            }
            catch(err) {
                // If login fails, try to sign up
                if(err.code.includes('not-found') || err.code.includes('invalid-credential') || err.code.includes('wrong-password')) {
                    try { 
                        await window.signupEmail(em, pw); 
                        closeModal('authModal'); 
                        alert("Sign Up Successful! You are now logged in.");
                    }
                    catch(e2) { 
                        console.error("Email Auth Failed:", e2);
                        alert("Authentication Failed. Error: " + (e2.message || "Invalid credentials or email format.")); 
                    }
                } else {
                    console.error("Email Auth Failed:", err);
                    alert("Authentication Failed. Error: " + (err.message || "Please check your network connection."));
                }
            }
        }

        async function submitNewBook(e) {
            e.preventDefault();
            playSound();
            
            let pdf = document.getElementById('nbPdf').value;
            
            // --- AUTO-FIX LINK LOGIC ---
            if (pdf.includes("drive.google.com") && pdf.includes("/view")) {
                pdf = pdf.replace("/view", "/preview");
            } else if (pdf.includes("dropbox.com") && (pdf.includes("dl=0") || pdf.includes("?dl=0"))) {
                pdf = pdf.replace("dl=0", "raw=1");
            } else if (pdf.includes("sharepoint.com") || pdf.includes("1drv.ms")) {
                if(pdf.includes("download=1")) pdf = pdf.replace("download=1", "action=embedview");
                if(!pdf.includes("action=embedview") && !pdf.includes("action=view")) {
                    pdf += (pdf.includes('?') ? '&' : '?') + 'action=embedview';
                }
            }

            const book = {
                title: document.getElementById('nbTitle').value,
                author: document.getElementById('nbAuthor').value,
                genre: document.getElementById('nbGenre').value,
                cover: document.getElementById('nbCover').value,
                pdfUrl: pdf,
                createdAt: new Date().toISOString()
            };
            
            try {
                await window.addBookToDB(book);
                alert(`Book "${book.title}" added successfully!`);
            } catch (error) {
                alert("Failed to add book. Do you have Admin permissions and Firestore write access?");
                console.error("Firestore Add Book Error:", error);
            }
            
            closeModal('adminModal');
            e.target.reset();
        }

        // Reader Logic
        function openBook(id, requireAuth) {
            if(requireAuth && (!appState.user || appState.user.isAnonymous)) {
                playSound();
                document.getElementById('authModal').classList.add('active');
                return;
            }
            playSound();
            const book = appState.books.find(b => b.id === id);
            if (!book) return;

            appState.currentBook = book;
            document.getElementById('readerTitle').innerText = book.title;
            
            // Set initial page number
            const initialPage = appState.progress[id] ? appState.progress[id].page : 1;
            document.getElementById('pageInput').value = initialPage;
            // Jump PDF to specific page and hide toolbar
            document.getElementById('pdfFrame').src = book.pdfUrl + (book.pdfUrl.includes('#') ? '&' : '#') + `page=${initialPage}&toolbar=0`;
            document.getElementById('readerModal').classList.add('active');


            // Update heart
            const isFav = appState.favorites.includes(id);
            document.getElementById('readerFavBtn').innerHTML = isFav ? '<i class="ph-fill ph-heart" style="color: red;"></i>' : '<i class="ph-heart"></i>';
        }

        function closeReader() {
            playSound();
            document.getElementById('readerModal').classList.remove('active');
            document.getElementById('pdfFrame').src = "";
            appState.currentBook = null;
            render();
        }

        async function saveCurrentPage() {
            playSound();
            const page = parseInt(document.getElementById('pageInput').value);
            const id = appState.currentBook.id;
            
            // Optimistically update UI state
            appState.progress[id] = { page, lastRead: new Date().toISOString() };
            
            try {
                await window.saveBookProgress(id, page);
                // Reload the PDF with the current page number for continuity
                document.getElementById('pdfFrame').src = appState.currentBook.pdfUrl + (appState.currentBook.pdfUrl.includes('#') ? '&' : '#') + `page=${page}&toolbar=0`;
                // Brief visual confirmation
                document.querySelector('.reader-controls button').innerText = 'SAVED!';
                setTimeout(() => document.querySelector('.reader-controls button').innerText = 'SAVE', 1000);
            } catch (error) {
                console.error("Failed to save progress:", error);
                alert("Failed to save progress. Are you logged in?");
            }
            render();
        }

        async function toggleReaderFav() {
            playSound();
            const id = appState.currentBook.id;
            try {
                const isFav = await window.toggleFav(id);
                document.getElementById('readerFavBtn').innerHTML = isFav ? '<i class="ph-fill ph-heart" style="color: red;"></i>' : '<i class="ph-heart"></i>';
            } catch (error) {
                console.error("Failed to toggle favorite:", error);
                alert("Failed to change favorite status. Are you logged in?");
            }
            render();
        }
    </script>
</body>
</html>